# MovementDefectMaterialToSupplierService

## Назначение сервиса и его основная ответственность

Сервис `MovementDefectMaterialToSupplierService` управляет процессом возврата
бракованных материалов поставщикам. Основные задачи:

- Создание документов на возврат брака
- Контроль количества возвращаемых материалов
- Обновление цен материалов при возврате
- Уведомление ответственных лиц через Telegram

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Form Requests:**
    - `StoreDefectMaterialToSupplierRequest` - валидация создания возврата
    - `UpdateMovementMaterialFromSupplierRequest` - валидация обновления цен
- **Models:**
    - `MovementMaterial` - перемещение материалов
    - `Order` - заказы системы
    - `Supplier` - поставщики
- **Laravel Facades:**
    - `DB` - для транзакций
    - `Log` - для логирования
- **Services:**
    - `InventoryService` - для проверки остатков брака
    - `TgService` - для отправки уведомлений
    - `UserService` - для получения списка кладовщиков

## Публичные методы

### store(StoreDefectMaterialToSupplierRequest $request): RedirectResponse

**Описание:** Создает документ на возврат бракованных материалов поставщику.

**Параметры запроса:**

- `material_id[]` - массив ID материалов
- `ordered_quantity[]` - массив количеств для возврата
- `supplier_id` - ID поставщика
- `comment` - комментарий к возврату

**Бизнес-логика:**

1. **Валидация данных:**
    - Проверка наличия материалов и количеств
    - Возврат с ошибкой при некорректных данных

2. **Проверка доступности материалов:**
    - Для каждого материала проверяется остаток брака через
      `InventoryService::defectMaterialInWarehouse()`
    - Нельзя вернуть больше чем есть на складе

3. **Создание документа возврата:**
    - Создание заказа с параметрами:
        - `supplier_id` - поставщик
        - `storekeeper_id` - ответственный кладовщик
        - `type_movement = 5` - тип "утилизация брака"
        - `status = 3` - завершенный
        - `completed_at` - текущая дата

4. **Формирование уведомлений:**
    - Список возвращаемых материалов
    - Название поставщика
    - Отправка администратору и кладовщикам

**Пример уведомления:**

```
Кладовщик [Имя] отгрузил возврат поставщику [Название]:
• Материал1 5 шт
• Материал2 2.5 кг
```

### update(UpdateMovementMaterialFromSupplierRequest $request, Order $order): bool|RedirectResponse

**Описание:** Обновляет цены материалов в документе возврата.

**Параметры:**

- `$request` - данные с ценами:
    - `id[]` - ID позиций материалов
    - `price[]` - новые цены
- `$order` - заказ для обновления

**Возвращает:**

- `bool` - `true` при успешном обновлении
- `RedirectResponse` - при ошибке валидации

**Логика:**

1. Валидация наличия ID и цен
2. Обновление статуса заказа на 3 (завершен)
3. Обновление цен в каждой позиции материала
4. Все операции в транзакции

## Используемые модели и репозитории

- **Order:** Заказы системы
    - `type_movement = 5` - утилизация брака
    - `status = 3` - завершен
    - `supplier_id` - поставщик
    - `storekeeper_id` - кладовщик

- **MovementMaterial:** Детали перемещения
    - `order_id` - ссылка на заказ
    - `material_id` - материал
    - `quantity` - количество
    - `price` - цена (обновляется в методе update)

- **Supplier:** Поставщики
    - Используется для получения названия в уведомлениях

## Интеграция с другими сервисами

- **InventoryService:**
    - `defectMaterialInWarehouse($material_id)` - проверка остатков брака

- **TgService:** Отправка уведомлений в Telegram

- **UserService:**
    - `getListStorekeepersWorkingToday()` - получение списка кладовщиков на
      смене

## Обработка ошибок и исключения

1. **Валидация входных данных:** Через Form Request классы
2. **Бизнес-валидация:** Проверка доступного количества брака
3. **Транзакционная целостность:** Все операции обернуты в DB::transaction
4. **Rollback при ошибках:** Откат транзакции при любом исключении
5. **Логирование ошибок:** В канал 'erp'
6. **User-friendly сообщения:** Понятные ошибки для пользователя

## Бизнес-правила и алгоритмы

### Процесс возврата брака:

1. **Инициация:**
    - Кладовщик выбирает материалы для возврата
    - Указывает поставщика и количество

2. **Проверка:**
    - Система проверяет наличие брака на складе
    - Блокирует попытку вернуть больше чем есть

3. **Документирование:**
    - Создается заказ-основание
    - Формируются позиции с материалами
    - Автоматически проставляется статус "завершен"

4. **Уведомление:**
    - Администратор получает сообщение о возврате
    - Остальные кладовщики информируются об операции

### Обновление цен:

- Используется для фиксации цен возврата
- Может вызываться после согласования с поставщиком
- Меняет только цены, не затрагивая количества

## Особенности реализации

1. **Автоматическое завершение:** Возврат сразу получает статус завершенного
2. **Строгий контроль:** Нельзя вернуть больше брака чем есть
3. **Полная транзакционность:** Все операции атомарны
4. **Система уведомлений:** Все заинтересованные стороны информируются
5. **Разделение ответственности:** Создание и обновление цен в разных методах

## Потенциальные проблемы

1. **Конкурентный доступ:** Возможна гонка состояний при проверке остатков
2. **Целостность данных:** Нет блокировки материалов при создании возврата
3. **Отсутствие аудита:** Не логируется старое значение цен при обновлении
4. **Жесткая привязка:** Тип движения захардкожен (type_movement = 5)

## Рекомендации по улучшению

1. **Блокировка записей:** Использовать SELECT FOR UPDATE при проверке остатков
2. **Аудит изменений:** Добавить логирование изменения цен
3. **Подтверждение операции:** Двухэтапный процесс с подтверждением
4. **Константы:** Вынести типы и статусы в отдельный класс
5. **Валидация цен:** Проверка на отрицательные значения

## Пример использования

```php
// Создание возврата
$response = MovementDefectMaterialToSupplierService::store($request);

// Обновление цен
$success = MovementDefectMaterialToSupplierService::update($request, $order);
```

## Дата последнего изменения

2025-12-05
