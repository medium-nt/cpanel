# WarehouseOfItemService

## Назначение сервиса и его основная ответственность

Сервис `WarehouseOfItemService` управляет операциями с товарами на складе
маркетплейсов. Основные задачи:

- Фильтрация и поиск товаров на складе
- Генерация и управление штрихкодами складского учета
- Обработка возвратов товаров
- Размещение товаров на полках хранения
- Создание записей о наличии товаров

## Зависимости и внедрения (constructor)

Сервис не требует внедрения зависимостей через конструктор. Используемые
импорты:

- **Models:**
    - `MarketplaceItem` - товары маркетплейсов
    - `MarketplaceOrder` - заказы маркетплейсов
    - `MarketplaceOrderItem` - позиции в заказах
    - `Sku` - SKU товаров
- **Laravel:**
    - `Builder` - для построения запросов
    - `Request` - HTTP запросы
    - `Carbon` - работа с датами
- **Services:**
    - `MarketplaceApiService` - для работы с API маркетплейсов

## Публичные методы

### getFiltered(Request $request): Builder

**Описание:** Формирует запрос для фильтрации товаров на складе.

**Параметры фильтрации:**

- `status` - статус товара (по умолчанию: [9, 10, 11, 12])
- `material` - поиск по названию материала (LIKE)
- `width` - точная ширина товара
- `height` - точная высота товара
- `shelf` - ID полки хранения

**Возвращает:** `Builder` - построитель запросов с join к marketplace_items

**Пример использования:**

```php
$query = $service->getFiltered($request);
$items = $query->paginate(15);
```

### getStorageBarcode(MarketplaceOrderItem $marketplace_item): string

**Описание:** Получает или генерирует складской штрихкод для товара.

**Алгоритм:**

1. Проверяет наличие существующего штрихкода
2. Если отсутствует - генерирует новый с помощью `generateBarcode()`
3. Сохраняет в БД
4. Возвращает штрихкод

**Возвращает:** 9-значный штрихкод с контрольной суммой по алгоритму Луна

### saveItemToStorage(MarketplaceOrderItem $item, int $shelfId): void

**Описание:** Размещает товар на полке хранения.

**Действия:**

- Устанавливает `shelf_id` для товара
- Меняет статус на 11 (на складе)
- Обновляет связанный заказ:
    - `returned_at` - дата возврата
    - `status` - статус 9 (возвращен)

### findRefundItemByBarcode($barcode): array

**Описание:** Ищет товар по штрихкоду для обработки возврата.

**Поддерживаемые типы штрихкодов:**

1. **Ozon FBS (15 символов)** - преобразуется в номер заказа
2. **Ozon возврат (начинается с 'ii')** - преобразуется в номер заказа
3. **Ozon FBO (начинается с 'OZN')** - ищет по SKU
4. **Складской штрихкод** - прямой поиск по `storage_barcode`

**Возвращает массив:**

```php
[
    'message' => 'Статус операции',
    'marketplace_item' => MarketplaceOrderItem|null,
    'marketplace_items' => Collection, // при нескольких найденных
    'returnReason' => 'Причина возврата'
]
```

**Сценарии возврата:**

- Пустой штрихкод → сообщение об ошибке
- Несколько найденных → предлагает выбрать
- Уже на складе → сообщение о статусе
- Найден один товар → возвращает товар и причину возврата

### getCreateItems($validatedData, MarketplaceItem $item): array

**Описание:** Создает записи о наличии товаров на складе.

**Параметры:**

- `$validatedData` - провалидированные данные:
    - `quantity` - количество для создания
    - `shelf_id` - ID полки хранения
- `$item` - модель товара маркетплейса

**Процесс создания:**

1. Создает заказ FBO со специальными параметрами
2. Создает позицию товара на складе
3. Генерирует складской штрихкод
4. Обновляет order_id с ссылкой на позицию
5. Возвращает массив созданных ID

**Особенности:**

- Тип выполнения: FBO
- Статус: 9 (возвращен)
- Автоматическая дата: 2 дня назад от текущей

## Приватные методы

### generateBarcode(int $id): string

**Описание:** Генерирует штрихкод с контрольной суммой по алгоритму Луна.

**Алгоритм:**

1. Дополняет ID до 8 цифр нулями слева
2. Применяет алгоритм Луна для расчета контрольной цифры
3. Возвращает 9-значный штрихкод

**Пример:**

```
ID: 123 → 000000123 → контрольная сумма: 5 → 0000001235
```

## Используемые модели и репозитории

- **MarketplaceOrderItem:** Основная модель для работы
    - `storage_barcode` - складской штрихкод
    - `shelf_id` - полка хранения
    - `status` - статус товара
- **MarketplaceOrder:** Заказы
    - `returned_at` - дата возврата
    - `status` - статус заказа
- **MarketplaceItem:** Товары
    - `title`, `width`, `height` - атрибуты товара
- **Sku:** Артикулы для поиска по FBO штрихкодам

## Интеграция с другими сервисами

- **MarketplaceApiService:**
    - `getOzonPostingNumberByBarcode()` - декодирование штрихкодов Ozon
    - `getOzonPostingNumberByReturnBarcode()` - декодирование возвратов
    - `getReturnReason()` - получение причины возврата

## Обработка ошибок и исключения

1. **Валидация входных данных:** На уровне контроллера
2. **Проверка существования записей:** В методах поиска
3. **Обработка пустых результатов:** Возврат appropriate сообщений
4. **Множественные результаты:** Предложение выбора пользователю

## Бизнес-правила и алгоритмы

### Статусы товаров:

- `3` - в обработке
- `9` - возвращен
- `10` - ?
- `11` - на складе
- `12` - ?

### Процесс обработки возврата:

1. Сканирование штрихкода
2. Определение типа штрихкода
3. Поиск товара в системе
4. Получение причины возврата из API
5. Предложение действий пользователю

### Алгоритм генерации штрихкода:

1. Получить ID записи
2. Дополнить до 8 цифр
3. Рассчитать контрольную сумму (алгоритм Луна)
4. Вернуть 9-значный код

## Особенности реализации

1. **Универсальный поиск:** Поддерживает множество форматов штрихкодов
2. **Автоматическая генерация:** Штрихкоды создаются по требованию
3. **Flexibility:** Гибкая фильтрация по множеству параметров
4. **Batch creation:** Возможность создания нескольких записей сразу

## Потенциальные проблемы

1. **Уникальность штрихкодов:** Нет проверки на дубликаты
2. **Производительность:** JOIN без индексов может быть медленным
3. **Хардкод:** Магические числа статусов
4. **Безопасность:** Нет проверки прав доступа

## Рекомендации по улучшению

1. **Индексы:** Добавить композитные индексы для частых запросов
2. **Кэширование:** Кэшировать результаты поиска по штрихкодам
3. **Константы:** Вынести статусы в enum
4. **Валидация:** Добавить проверку уникальности штрихкодов
5. **Рефакторинг:** Разделить на более мелкие сервисы по ответственности

## Пример использования

```php
// Фильтрация товаров
$items = $service->getFiltered($request)->get();

// Получение штрихкода
$barcode = $service->getStorageBarcode($item);

// Поиск по штрихкоду
$result = $service->findRefundItemByBarcode('0000001235');

// Создание товаров на складе
$ids = $service->getCreateItems($data, $marketplaceItem);
```

## Дата последнего изменения

2025-12-05
