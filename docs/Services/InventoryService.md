# InventoryService

## Назначение сервиса и его основная ответственность

Сервис `InventoryService` отвечает за управление складскими операциями и
инвентаризацией. Основные задачи:

- Расчет остатков материалов на складе и в цеху
- Учет бракованных материалов
- Управление списанием материалов
- Создание инвентаризационных ведомостей
- Агрегирование данных по количествам материалов

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Models:**
    - `InventoryCheck` - инвентаризации
    - `InventoryCheckItem` - позиции инвентаризации
    - `MarketplaceOrderItem` - товары маркетплейсов
    - `Material` - материалы
    - `MovementMaterial` - перемещения материалов
- **Laravel:**
    - `DB` - для транзакций
    - `Log` - для логирования операций

## Публичные методы

### materialInWorkshop($materialId): float

**Описание:** Рассчитывает количество материала в производственном цеху.

**Учитываемые операции:**

- Приход материалов в цех (type: 2, status: 3)
- Расход материалов на товары (type: 3)
- Перемещение в брак (type: 4)
- Списание остатков (type: 6, 7)

**Возвращает:** Количество материалов с точностью до 2 знаков

**Формула расчета:**

```
Приход - Расход на товары - Брак - Списания = Остаток в цеху
```

### materialInWarehouse($materialId): float

**Описание:** Рассчитывает количество материала на складе.

**Учитываемые операции:**

- Приход на склад (type: 1, status: 3)
- Запросы на перемещение в цех (type: 2, status: 0)
- Фактически отгруженные материалы (type: 2, status ≠ [-1, 0])

**Возвращает:** Количество материалов с точностью до 2 знаков

**Особенности:**

- Учитывает только завершенные перемещения (не отмененные и не новые)

### defectMaterialInWarehouse($materialId): float

**Описание:** Рассчитывает количество бракованного материала на складе.

**Учитываемые операции:**

- Приход брака на склад (type: 4, status: 3)
- Утилизация брака (type: 5, status: 3)

**Возвращает:** Количество бракованных материалов

### remnantsMaterialInWarehouse($materialId): float

**Описание:** Рассчитывает количество списанных остатков на складе.

**Учитываемые операции:**

- Приход остатков на списание (type: 7, status: 3)
- Фактическое списание (type: 8, status: 3)

**Возвращает:** Количество списанных материалов

### countMaterial($materialId, $type, $status): float

**Описание:** Базовый метод для подсчета материалов по типу и статусу
перемещения.

**Параметры:**

- `$materialId` - ID материала
- `$type` - тип перемещения (order.type_movement)
- `$status` - статус перемещения (order.status)

**Возвращает:** Суммарное количество материалов

**Используется в других методах как строительный блок.**

### materialsQuantityBy(string $type): array

**Описание:** Возвращает массив с количеством всех материалов указанного типа.

**Поддерживаемые типы:**

- `warehouse` - материалы на складе
- `workhouse` - материалы в цеху
- `defect_warehouse` - бракованные материалы на складе

**Возвращает массив:**

```php
[
    [
        'material' => Material model,
        'quantity' => float, // основное количество
        'remnants' => float, // доп. количество (только для брака)
    ],
    // ...
]
```

**Особенности:**

- Для бракованных материалов также возвращает остатки
- Использует match expression для выбора метода расчета

### createInventory($request): bool

**Описание:** Создает инвентаризационную ведомость.

**Процесс создания:**

1. Создает запись инвентаризации с комментарием
2. Находит товары для инвентаризации:
    - Статус [11, 13] (на складе/в сборке)
    - Опциональная фильтрация по полке
3. Создает позиции инвентаризации:
    - ID инвентаризации
    - ID товара
    - Ожидаемая полка хранения
4. Логирует операцию

**Возвращает:** `true` при успехе, `false` при ошибке

## Используемые модели и репозитории

- **Material:** Справочник материалов
- **MovementMaterial:** Перемещения материалов (связь с Order)
- **InventoryCheck:** Инвентаризации
- **InventoryCheckItem:** Позиции инвентаризаций
- **MarketplaceOrderItem:** Товары на складе

## Типы перемещений материалов (type_movement):

1. Приход на склад от поставщика
2. Перемещение со склада в цех
3. Расход на товар
4. Перемещение брака поставщику
5. Утилизация брака
6. Списание материалов
7. Приход остатков на списание
8. Фактическое списание остатков

## Интеграция с другими сервисами

Сервис является самодостаточным и предоставляет данные для других компонентов
системы. Не имеет прямых вызовов других сервисов.

## Обработка ошибок и исключения

1. **Транзакции:** Все операции в `createInventory` обернуты в транзакцию
2. **Логирование:** Все ошибки логируются в канал 'erp'
3. **Откат при ошибках:** Rollback при любом исключении
4. **Возврат статуса:** `false` при ошибке для программной обработки

## Бизнес-правила и алгоритмы

### Расчет остатков:

1. **Склад:**
   ```
   Приход - Запросы - Отгрузки = Остаток
   ```

2. **Цех:**
   ```
   Приход - Расходы - Брак - Списания = Остаток
   ```

3. **Брак:**
   ```
   Приход - Утилизация = Остаток
   ```

### Инвентаризация:

- Включает товары со статусами 11 и 13
- Можно ограничить конкретной полкой
- Фиксирует ожидаемое местоположение

## Особенности реализации

1. **Математическая точность:** Все расчеты с округлением до 2 знаков
2. **Атомарность:** Использование транзакций для консистентности
3. **Современный синтаксис:** Match expression в PHP 8+
4. **Batch операции:** Использование insert для множественного создания
5. **Гибкая фильтрация:** Опциональная фильтрация по полкам

## Потенциальные проблемы

1. **Производительность:** N+1 запросы в `materialsQuantityBy`
2. **Магические числа:** Типы и статусы захардкожены
3. **Сложность расчетов:** Сложная формула для остатков в цеху
4. **Нет кэширования:** Расчеты выполняются каждый раз

## Рекомендации по улучшению

1. **Кэширование:** Закэшировать результаты расчетов остатков
2. **Оптимизация:** Использовать агрегирующие запросы для материалов
3. **Константы:** Вынести типы и статусы в enum
4. **Events:** Добавить события для аудита изменений остатков
5. **Тесты:** Покрыть расчеты юнит-тестами

## Пример использования

```php
// Расчет остатков
$warehouse = InventoryService::materialInWarehouse(1);
$workshop = InventoryService::materialInWorkshop(1);

// Получение всех остатков
$materials = InventoryService::materialsQuantityBy('warehouse');

// Создание инвентаризации
$success = $service->createInventory($request);
```

## Дата последнего изменения

2025-12-05
