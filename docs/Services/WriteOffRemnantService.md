# WriteOffRemnantService

## Назначение сервиса и его основная ответственность

Сервис `WriteOffRemnantService` отвечает за процесс списания остатков материалов
на складе. Основная задача - обеспечить корректное списание материалов с
контролем остатков и ведением истории операций.

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Form Requests:**
    - `StoreRemnantsRequest` - валидация данных для списания
- **Models:**
    - `MovementMaterial` - модель перемещения/списания материалов
    - `Order` - модель заказов для фиксации операции
- **Laravel Facades:**
    - `DB` - для управления транзакциями
    - `Log` - для логирования операций в ERP канал
- **Services:**
    - `InventoryService` - для проверки остатков материалов на складе

## Публичные методы

### store(StoreRemnantsRequest $request): RedirectResponse

**Описание:** Создает документ на списание остатков материалов со склада.

**Параметры:**

- `$request` - валидированные данные запроса содержащий:
    - `material_id[]` - массив ID материалов
    - `ordered_quantity[]` - массив количеств для списания
    - `comment` - комментарий к операции

**Возвращает:** `Illuminate\Http\RedirectResponse`

**Бизнес-логика:**

1. **Валидация входных данных:**
    - Проверка наличия материалов и количеств
    - Возврат с ошибкой при некорректных данных

2. **Обработка списания в транзакции:**
    - Создание заказа с параметрами:
        - `storekeeper_id` - ID кладовщика
        - `type_movement = 8` - тип операции "списание остатков"
        - `status = 3` - статус "завершен"
        - `completed_at` - текущая дата и время
    - Для каждого материала:
        - Проверка остатка через
          `InventoryService::remnantsMaterialInWarehouse()`
        - Валидация что количество для списания ≤ остатка
        - Создание записи в `MovementMaterial`

3. **Логирование операции:**
    - Формирование списка списанных материалов
    - Запись в лог канал 'erp'

4. **Обработка ошибок:**
    - Откат транзакции при любой ошибке
    - Возврат с сообщением об ошибке

**Пример логируемого сообщения:**

```
Кладовщик [Имя] создал новое списание остатков:
• Материал1 5 шт
• Материал2 2.5 м
```

## Используемые модели и репозитории

- **Order:** Заказы системы
    - `type_movement = 8` - списание остатков
    - `status = 3` - завершенная операция
    - `storekeeper_id` - ответственный кладовщик
    - `completed_at` - дата выполнения

- **MovementMaterial:** Детали перемещения/списания
    - `order_id` - ссылка на заказ-основание
    - `material_id` - ID материала
    - `quantity` - списанное количество

## Интеграция с другими сервисами

- **InventoryService:**
    - Метод `remnantsMaterialInWarehouse($material_id)` для проверки доступного
      количества

## Обработка ошибок и исключения

1. **Валидация на уровне контроллера:** Через `StoreRemnantsRequest`
2. **Бизнес-валидация:** Проверка достаточного количества материала
3. **Транзакционная целостность:** Все операции в DB::transaction
4. **Обработка исключений:** Try-catch с откатом транзакции
5. **User-friendly ошибки:** Понятные сообщения для пользователя

## Бизнес-правила и алгоритмы

### Правила списания:

1. **Только кладовщик:** Операцию может выполнить только пользователь с ролью
   кладовщика
2. **Контроль остатков:** Нельзя списать больше чем есть на складе
3. **Фиксация в системе:** Каждое списание создает заказ и детали перемещения
4. **Автоматическое завершение:** Списание сразу имеет статус "завершено"

### Алгоритм выполнения:

1. Получить и валидировать данные
2. Начать транзакцию
3. Создать заказ списания
4. Для каждого материала:
    - Проверить остаток
    - Создать запись списания
5. Залогировать операцию
6. Коммит транзакции
7. Вернуть успешный ответ

## Особенности реализации

1. **Строгий контроль остатков:** Проверка перед созданием каждой записи
2. **Немедленное завершение:** Списание не требует дополнительного подтверждения
3. **Детальное логирование:** Формируется читаемый список операций
4. **Атомарность:** Все или ничего - транзакционная безопасность
5. **Ролевая безопасность:** Операция привязана к конкретному кладовщику

## Потенциальные проблемы

1. **Конкурентный доступ:** Возможна гонка состояний при проверке остатков
2. **Производительность:** Запрос остатка для каждой позиции по отдельности
3. **Нет частичного списания:** При ошибке в одной позиции все откатывается
4. **Магические числа:** Тип и статус захардкожены

## Рекомендации по улучшению

1. **Блокировка записей:** Использовать SELECT FOR UPDATE при проверке остатков
3. **Batch проверка:** Проверять остатки всех материалов одним запросом
4. **Добавить причину списания:** Поле для указания причины списания
5. **Подтверждение операции:** Двухэтапный процесс с подтверждением
6. **Константы:** Вынести типы и статусы в отдельный класс

## Пример использования

```php
// В контроллере
$result = WriteOffRemnantService::store($request);

// При успешном выполнении перенаправит с сообщением
// При ошибке вернет на форму с сообщением об ошибке
```

## Дата последнего изменения

2025-12-05
