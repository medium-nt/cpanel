# OrderService

## Назначение сервиса и его основная ответственность

Сервис `OrderService` предоставляет статические методы для фильтрации и выборки
заказов из базы данных. Основная ответственность - формирование запросов к
моделям Order с применением различных фильтров.

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Все зависимости импортируются
напрямую:

- `App\Models\Order` - модель заказов
- `Illuminate\Database\Eloquent\Builder` - для типизации возвращаемого значения
- `Illuminate\Support\Carbon` - для работы с датами

## Публичные методы

### getFiltered($request): Builder

**Описание:** Создает отфильтрованный запрос к заказам на основе параметров
запроса.

**Параметры:**

- `$request` (mixed) - HTTP запрос с фильтрами

**Возвращает:** `Illuminate\Database\Eloquent\Builder` - построитель запросов с
примененными фильтрами

**Используемые модели и репозитории:**

- `Order` - Eloquent модель заказов

## Бизнес-логика и алгоритмы

### Алгоритм фильтрации в методе getFiltered:

1. **Фильтр по статусу:**
    - По умолчанию: `[0, 1]` (активные заказы)
    - При `status = '-1'`: `[-1]` (отмененные)
    - При `status = '3'`: `[3]` (выполненные)

2. **Фильтр по типу перемещения:**
    - Если указан `type_movement` в запросе - фильтрует по этому значению
    - По умолчанию: `[4, 7]` (типы по умолчанию)

3. **Фильтр по пользователям:**
    - Ищет заказы где пользователь является либо швеей (`seamstress_id`), либо
      закройщиком (`cutter_id`)
    - Использует логику OR в подзапросе

4. **Фильтр по датам:**
    - `date_start`: фильтрует заказы созданные после указанной даты
    - `date_end`: фильтрует заказы созданные до конца указанного дня (использует
      `endOfDay()`)

5. **Сортировка:** Применяется `latest()` для сортировки по убыванию даты
   создания

## Обработка ошибок и исключения

Сервис не содержит явной обработки ошибок. Возможные проблемы:

- Некорректный формат дат при парсинге `date_end`
- Отсутствие необходимых параметров в `$request`

## Интеграция с другими сервисами

Сервис не имеет прямых интеграций с другими сервисами. Используется как
утилитарный класс для формирования запросов.

## Особенности реализации

1. **Статический класс:** Все методы статические, не требуется создание
   экземпляра
2. **Flexible filtering:** Поддерживает множественные фильтры которые могут
   комбинироваться
3. **Match expression:** Использует современный синтаксис match/case для
   фильтрации статусов
4. **Date handling:** Корректно обрабатывает временные интервалы включая конец
   дня для `date_end`
5. **User filtering:** Умный поиск по двум ролям пользователя (швея/закройщик)

## Рекомендации по использованию

```php
// Пример использования
$filteredOrders = OrderService::getFiltered($request);
$orders = $filteredOrders->paginate(15);
```

## Дата последнего изменения

2025-12-05
