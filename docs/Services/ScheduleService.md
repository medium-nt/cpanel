# ScheduleService

## Назначение сервиса и его основная ответственность

Сервис `ScheduleService` управляет рабочим графиком и сменами сотрудников.
Основные задачи:

- Проверка наличия рабочего дня у сотрудника
- Управление открытием/закрытием смен
- Определение времени начала/конца рабочего дня
- Валидация временных интервалов работы
- Подготовка данных для календаря

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Models:**
    - `Schedule` - график работы сотрудников
    - `Setting` - системные настройки
    - `User` - пользователи системы
- **Carbon:** Библиотека для работы с датами и временем

## Публичные методы

### getScheduleByUserId($userId): array

**Описание:** Получает график сотрудника в формате для календаря.

**Параметры:**

- `$userId` - ID сотрудника

**Возвращает:** Массив событий для календаря:

```php
[
    [
        'id' => 1,
        'start' => '2024-01-01',
        'display' => 'background',
        'shift_start' => '09:00:00',
        'shift_end' => '18:00:00',
    ],
    // ...
]
```

**Особенности:**

- `display = 'background'` - для фонового отображения в календаре
- Включает время открытия/закрытия смены

### isWorkDay(): bool

**Описание:** Проверяет, является ли сегодня рабочим днем для текущего
пользователя.

**Логика:**

- Берет текущую дату
- Ищет запись в расписании для текущего пользователя
- Возвращает `true` если запись существует

**Возвращает:** `true` если сегодня рабочий день

### isEnabledSchedule(): bool

**Описание:** Проверяет, включена ли система графика в настройках.

**Возвращает:** Значение настройки `is_enabled_work_schedule`

### getStartWorkDay(): string

**Описание:** Получает время начала рабочего дня из настроек.

**Возвращает:** Время в формате 'HH:mm' (например, '09:00')

### getEndWorkDay(): string

**Описание:** Получает время конца рабочего дня из настроек.

**Возвращает:** Время в формате 'HH:mm' (например, '18:00')

### hasWorkDayStarted(): bool

**Описание:** Проверяет, начался ли рабочий день по времени.

**Логика:**

- Текущее время должно быть >= начала дня
- И < конца рабочего дня

**Возвращает:** `true` если текущее время в рамках рабочего дня

### isBeforeStartWorkDay(User $user): bool

**Описание:** Проверяет, что пользователь еще не открывал смену сегодня.

**Условия:**

- `shift_is_open = false` - смена не открыта
- `closed_work_shift = '00:00:00'` - время закрытия не установлено

**Возвращает:** `true` если смена еще не началась

### openWorkShift(User $user): void

**Описание:** Открывает рабочую смену для сотрудника.

**Действия:**

- Находит или создает запись расписания на сегодня
- Устанавливает текущее время как время открытия смены
- Сохраняет изменения

### closeWorkShift(User $user): void

**Описание:** Закрывает рабочую смену для сотрудника.

**Действия:**

- Находит или создает запись расписания на сегодня
- Устанавливает текущее время как время закрытия смены
- Сохраняет изменения

## Приватные методы

### getSchedule(User $user): Schedule

**Описание:** Получает или создает запись расписания на сегодня для
пользователя.

**Логика:**

1. Ищет запись по user_id и сегодняшней дате
2. Если не найдена - создает новую запись
3. Возвращает модель Schedule

## Используемые модели и репозитории

- **Schedule:** График работы
    - `user_id` - сотрудник
    - `date` - дата
    - `shift_opened_time` - время открытия смены
    - `shift_closed_time` - время закрытия смены

- **User:** Сотрудники
    - `shift_is_open` - флаг открытой смены
    - `closed_work_shift` - время закрытия смены

- **Setting:** Настройки системы
    - `is_enabled_work_schedule` - включение графиков
    - `working_day_start` - начало дня
    - `working_day_end` - конец дня

## Интеграция с другими сервисами

Сервис является самодостаточным и используется другими компонентами для проверки
и управления рабочим временем сотрудников.

## Обработка ошибок и исключения

Сервис не содержит явной обработки ошибок. Возможные проблемы:

- Отсутствие необходимых настроек в таблице settings
- Некорректный формат времени в настройках
- Отсутствие пользователя при проверке isWorkDay()

## Бизнес-правила и алгоритмы

### Управление сменами:

1. **Перед началом смены:** `isBeforeStartWorkDay() = true`
2. **Открытие смены:** `openWorkShift()` - записывается время
3. **В течение смены:** `hasWorkDayStarted()` контролирует время
4. **Закрытие смены:** `closeWorkShift()` - записывается время

### Проверка рабочего дня:

- Сначала проверяется включенность системы графиков
- Затем проверяется наличие записи в расписании
- Далее проверяется временной интервал

## Особенности реализации

1. **Гибкость:** Время работы настраивается через системные настройки
2. **Автоматическое создание:** При необходимости создаются записи расписания
3. **Формат для календаря:** `getScheduleByUserId` возвращает данные в нужном
   формате
4. **Разделение ответственности:** Проверка времени и управление сменами в
   разных методах

## Потенциальные проблемы

1. **Timezone:** Нет учета часовых поясов
2. **Null safety:** Прямой вызов методов без проверки null
3. **Формат времени:** Нет валидации формата времени из настроек
4. **Состояние пользователя:** Дублирование информации (Schedule и User)

## Рекомендации по улучшению

1. **Timezone:** Добавить работу с часовыми поясами
2. **Кэширование:** Закэшировать настройки времени
3. **Валидация:** Добавить проверку формата времени
4. **Events:** Добавить события при открытии/закрытии смен
5. **Audit:** Логирование операций со сменами
6. **Бизнес-инкапсуляция:** Объединить проверки состояния в один метод

## Пример использования

```php
// Проверка рабочего дня
if (ScheduleService::isWorkDay() && ScheduleService::hasWorkDayStarted()) {
    // бизнес-логика рабочего времени
}

// Управление сменой
if (ScheduleService::isBeforeStartWorkDay($user)) {
    ScheduleService::openWorkShift($user);
}

// Получение графика для календаря
$schedule = ScheduleService::getScheduleByUserId($userId);
```

## Дата последнего изменения

2025-12-05
