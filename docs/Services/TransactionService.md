# TransactionService

## Назначение сервиса и его основная ответственность

Сервис `TransactionService` управляет всеми финансовыми транзакциями и расчетом
заработной платы в системе. Основные задачи:

- Начисление заработной платы и бонусов сотрудникам
- Управление финансовыми транзакциями (начисления/списания)
- Расчет мотивационных выплат по производству
- Обработка штрафов и удержаний
- Формирование финансовых отчетов

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Form Requests:**
    - `CreateTransactionRequest` - валидация создания транзакций
- **Models:**
    - `MarketplaceOrderItem` - позиции заказов
    - `Motivation` - мотивационные схемы
    - `Rate` - ставки оплаты
    - `Schedule` - график работы
    - `Setting` - настройки системы
    - `Transaction` - финансовые транзакции
    - `User` - пользователи
- **Laravel:**
    - `Builder` - построитель запросов
    - `Collection` - коллекции
    - `Request` - HTTP запросы
    - `Carbon` - работа с датами
    - `DB` - для сложных запросов
    - `Log` - логирование

## Публичные методы

### Управление транзакциями

#### store(CreateTransactionRequest $request): bool

**Описание:** Создает ручную транзакцию (начисление или списание).

**Параметры:**

- `type` - тип (`bonus` | `salary` | `company`)
- `transaction_type` - направление (`in` | `out`)
- `amount` - сумма
- `user_id` - пользователь (если не `company`)
- `title` - назначение
- `accrual_for_date` - дата начисления

**Бизнес-логика:**

1. Проверяет баланс компании при списании (`out`)
2. Определяет тип бонуса (`type === 'bonus'`)
3. Создает транзакцию через `addTransaction`
4. Логирует операцию

### Начисление заработной платы

#### accrualSeamstressesSalary($test = false): void

**Описание:** Начисляет заработную плату швеям за выполненные вчера заказы.

**Алгоритм:**

1. Получает всех швей с заказами за вчера
2. Для каждой швеи:
    - Рассчитывает общую ширину выполненных заказов
    - Находит мотивационные схемы
    - Для каждого заказа:
        * Рассчитывает ЗП по ставкам материалов
        * Рассчитывает бонус по мотивации
        * Создает транзакции ЗП и бонусов
3. Логирует все начисления

#### accrualCuttersSalary($test = false): void

**Описание:** Начисляет заработную плату закройщикам за выполненные вчера
заказы.

**Логика аналогична швеям, но использует:**

- `cutting_completed_at` - дата выполнения раскроя
- Ставки `cutter_rate`
- Бонусы `cutter_bonus`

#### accrualStorekeeperSalary(): void

**Описание:** Начисляет зарплату кладовщикам (фиксированная ставка).

**Логика:**

- Находит кладовщиков, работавших вчера
- Начисляет `salary_rate` как расход (`out`)

#### accrualOtkSalary(): void

**Описание:** Начисляет зарплату сотрудникам ОТК.

### Управление бонусами

#### activateHoldBonus(): void

**Описание:** Активирует замороженные бонусы (старше 14 дней).

**Логика:**

- Находит бонусы со статусом 0 (замороженные)
- Старше 14 дней от даты начисления
- Меняет статус на 1 (активный)

#### getBonusForTodayOrdersByUsers()

**Описание:** Рассчитывает бонус за заказы, выполненные сегодня.

**Логика:**

- Получает заказы выполненные сегодня
- Рассчитывает общую ширину
- Находит мотивационную схему
- Возвращает соответствующий бонус

### Финансовые расчеты и отчеты

#### getSeamstressBalance(string $type, $isHoldBonus = false): int

**Описание:** Возвращает баланс пользователя.

**Типы:**

- `salary` - только зарплата
- `bonus` - бонусы (можно включить замороженные)

**Формула:** `Начисления (out) - Списания (in)`

#### getLastPayouts(?User $user, int $count, bool $isBonus = false): Collection

**Описание:** Возвращает последние выплаты.

**Структура ответа:**

```php
[
    'payout_date' => 'дата выплаты',
    'net_total' => сумма выплаты,
    'accrual_range' => [
        'from' => 'начало периода',
        'to' => 'конец периода'
    ]
]
```

#### getCashflowFiltered(Request $request)

**Описание:** Формирует отчет о движении денежных средств.

**SQL запрос:** Группировка по пользователю и дате выплаты

#### getSumOfPayout(Request $request)

**Описание:** Рассчитывает сумму к выплате за период.

#### getHoldBonus(?User $user): Collection

**Описание:** Возвращает замороженные бонусы с датой активации.

### Фильтрация и поиск

#### getFiltered(Request $request): Builder

**Описание:** Формирует запрос для фильтрации транзакций.

**Фильтры:**

- Пользователь (только свой для не-админов)
- Период дат
- Тип (`salary` | `company`)

#### getTotalByType(Request $request, bool $isBonus, $company = false): float

**Описание:** Рассчитывает общий баланс.

**Параметры:**

- `$isBonus` - true для бонусов
- `$company` - true для баланса компании

### Штрафы

#### penalizeUserForOrderCancellation(MarketplaceOrderItem $marketplaceOrderItem): void

**Описание:** Начисляет штраф за отмену заказа.

**Логика:**

- Берет сумму штрафа из настроек
- Создает транзакцию типа `in` (списание)
- Логирует операцию

## Приватные методы

### Вспомогательные

#### addTransaction(?User $user, $amount, $transaction_type, $title, $accrual_for_date, $type, bool $isBonus): void

**Описание:** Базовый метод создания транзакции.

**Статусы:**

- Бонусы: `0` (заморожен) → `1` (активен)
- Компания: `2` (оплачено)
- Зарплата: `1` (активна)

#### getSeamstressesWithOrders(): Collection

**Описание:** Получает швей с заказами за вчера.

#### getCuttersWithOrders(): Collection

**Описание:** Получает закройщиков с заказами за вчера.

#### processAccrual(User $user, bool $test): void

**Описание:** Обрабатывает начисления для одного пользователя.

**Форматы вывода при тесте:**

```html
<b>Швея: Имя</b><br>
- Заказ #ID (OrderID), ширина: X м. ЗП за заказ: Y руб., бонус: Z баллов.<br>
Всего: T м, зп: S руб., бонус: B баллов.<br>
```

#### processAccrualMotivationAndSalary(User $user, MarketplaceOrderItem $marketplaceOrderItems, Collection $motivations, array $result, bool $test): array

**Описание:** Рассчитывает ЗП и бонус для одного заказа.

**Особенности расчета бонусов:**

- При переходе через границу мотивации - пропорциональное разделение
- Учитывает предыдущий и текущий уровень мотивации

#### getCompensationDetails(Collection $motivations, int $allWidth, User $user, MarketplaceOrderItem $marketplaceOrderItems): array

**Описание:** Получает детали компенсации для заказа.

**Возвращает:**

```php
[
    'nowMotivationBonus' => текущий бонус,
    'from' => начало диапазона мотивации,
    'salary' => зарплата за заказ
]
```

## Используемые модели и их поля

### Transaction

- `user_id` - пользователь (NULL для компании)
- `title` - назначение платежа
- `accrual_for_date` - дата начисления
- `amount` - сумма
- `transaction_type` - `in` (списание) или `out` (начисление)
- `status` - 0 (заморожен), 1 (активен), 2 (оплачено)
- `is_bonus` - true для бонусов
- `paid_at` - дата выплаты

### Motivation

- `from` - начало диапазона (в метрах)
- `to` - конец диапазона
- `bonus` - бонус для швей
- `not_cutter_bonus` - бонус для швей без кроя
- `cutter_bonus` - бонус для закройщиков

### Rate

- `user_id` - пользователь
- `material_id` - материал
- `rate` - базовая ставка
- `not_cutter_rate` - ставка без кроя
- `cutter_rate` - ставка закройщика

## Бизнес-правила и алгоритмы

### Расчет заработной платы:

1. **ЗП = Σ(ширина × ставка материала)**
2. **Бонус = Σ(ширина × ставка бонуса)**
3. **При переходе границы мотивации:**
    - Часть до границы × старый бонус
    - Часть после границы × новый бонус

### Заморозка бонусов:

- Все бонусы создаются со статусом 0 (заморожен)
- Через 14 дней автоматически активируются
- Период заморозки настраивается

### Штрафы:

- За отмену заказа - из настроек
- За незакрытую смену - из настроек
- За опоздание - индивидуальный расчет

## Особенности реализации

1. **Сложная мотивация:** Многоуровневая система бонусов
2. **Раздельный учет:** Зарплата и бонусы учитываются отдельно
3. **Гибкие ставки:** Разные ставки для разных материалов и ролей
4. **Тестовый режим:** Возможность тестового расчета без реальных транзакций
5. **SQL агрегаты:** Использование сложных SQL запросов для отчетов

## Потенциальные проблемы

1. **Сложность:** Более 600 строк кода
2. **Дублирование:** Похожая логика для швей и закройщиков
3. **Магические числа:** Статусы захардкожены
4. **Вывод в stdout:** Методы с тестовым режимом используют echo
5. **Производительность:** Множественные запросы в циклах

## Рекомендации по улучшению

1. **Разделение:** Выделить расчет ЗП и бонусов в отдельные сервисы
2. **Refactoring:** Убрать дублирование кода
3. **Queue:** Перенести расчеты в фоновые задачи
4. **Events:** Добавить события для транзакций
5. **Constants:** Вынести статусы в константы
6. **Testing:** Добавить unit-тесты для расчетов

## Пример использования

```php
// Ручное начисление
TransactionService::store($request);

// Начисление ЗП (через cron)
TransactionService::accrualSeamstressesSalary();
TransactionService::accrualCuttersSalary();

// Получение баланса
$balance = TransactionService::getSeamstressBalance('salary');

// Активация бонусов
TransactionService::activateHoldBonus();
```

## Дата последнего изменения

2025-12-05
