# MarketplaceOrderItemService

## Назначение сервиса и его основная ответственность

Сервис `MarketplaceOrderItemService` является одним из ключевых сервисов
системы, управляя всем жизненным циклом позиций заказов с маркетплейсов.
Основные задачи:

- Управление статусами заказов (новый, в работе, раскрой, пошив, маркировка,
  готов)
- Распределение заказов между сотрудниками (швеями, закройщиками)
- Резервирование материалов и контроль остатков
- Работа с историей заказов и возвратами
- Расчет рейтингов и производительности сотрудников
- Интеграция с Telegram для уведомлений

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Jobs:**
    - `SendTelegramMessageJob` - асинхронные уведомления
- **Models:**
    - `MarketplaceOrder` - заказы маркетплейсов
    - `MarketplaceOrderHistory` - история заказов
    - `MarketplaceOrderItem` - позиции заказов
    - `MovementMaterial` - перемещения материалов
    - `Order` - внутренние заказы
    - `Setting` - настройки системы
    - `Sku` - артикулы товаров
    - `User` - пользователи
- **Services:**
    - `MarketplaceApiService` - работа с API маркетплейсов
    - `TgService` - отправка сообщений
    - `TransactionService` - финансовые операции
    - `ScheduleService` - проверка графика работы
    - `InventoryService` - инвентаризация

## Публичные методы

### Фильтрация и поиск

#### getFiltered($request): Builder

**Описание:** Формирует запрос для фильтрации позиций заказов.

**Особенности фильтрации:**

- Разные статусы по умолчанию для разных ролей:
    - OTK → 'cut'
    - Закройщик → 'cutting'
    - Швея → 'in_work'
    - Другие → 'new'
- Поддержка поиска по штрихкоду Ozon (15 символов)
- Фильтрация по пользователю, датам, маркетплейсу

**Поддерживаемые статусы:**

- `new` (0) - новый
- `in_work` (4) - в работе у швеи
- `done` (3) - выполнен
- `labeling` (5) - маркировка
- `cutting` (7) - в раскрое
- `cut` (8) - раскроен

### Управление заказами

#### cancelToSeamstress(MarketplaceOrderItem $marketplaceOrderItem): array

**Описание:** Отменяет заказ у швеи/закройщика с возвратом материалов.

**Логика отмены:**

1. Проверка статуса (допустимы: 4, 5, 7)
2. **При статусе 7 (раскрой):**
    - Удаление резерва материалов
    - Сброс cutter_id и статуса
3. **При статусе 4 или 5 (пошив/маркировка):**
    - Удаление резерва материалов и зарплаты
    - Статус меняется на 8 (если есть закройщик) или 0
4. **Штраф для не-админов:** Начисляется штраф за отмену

### Рабочие процессы

#### getNewOrderItem(): array

**Описание:** Основной метод получения нового заказа в работу.

**Алгоритм:**

1. Проверка расписания работы
2. Проверка лимита заказов у пользователя
3. Проверка дневного лимита для закройщиков
4. Поиск доступных заказов:
    - Проверка наличия материалов
    - Проверка доступа к материалам
    - Проверка резерва
5. Резервирование и назначение заказа

#### assignOrderToUser($marketplaceOrderItem): array

**Описание:** Назначает заказ сотруднику с созданием резерва материалов.

**Логика:**

1. Обновление статуса и назначение исполнителя
2. Создание заказа на расход материалов (type_movement = 3)
3. Создание позиций MovementMaterial:
    - Закройщик: только материалы типа 1 (ткани)
    - Швея: все материалы кроме типа 1 (если есть закройщик) или все материалы

### Статистика и рейтинги

#### getRating(): Collection

**Описание:** Возвращает рейтинг сотрудников за разные периоды.

**Периоды:**

- `ratingNow` - за сегодня
- `rating2week` - за последние 2 недели
- `rating1month` - за последний месяц

**Формула рейтинга:** Средний размер изделия (ширина/100)

#### getSeamstressesLargeSizeRating(array $dates): array

**Описание:** Детальный рейтинг швей по датам за последние 7 дней.

#### getDatesByLargeSizeRating($daysAgo): array

**Описание:** Генерирует массив дат для рейтинга.

### Счетчики

#### toWork(): int

Количество заказов в работе у швеи.

#### toCutting(): int

Количество заказов в раскрое у закройщика.

#### new(): int

Количество новых заказов.

#### cut(): int

Количество раскроенных заказов.

#### urgent(): int

Количество срочных FBS заказов.

### Управление историей

#### saveOrderToHistory(MarketplaceOrderItem $marketplaceOrderItem): void

**Описание:** Сохраняет заказ в историю при возврате товара.

**Логика:**

- Создает запись в MarketplaceOrderHistory
- Меняет статус основного заказа на 9 (возврат)

#### restoreOrderFromHistory(MarketplaceOrderItem $selectedItem): void

**Описание:** Восстанавливает заказ из истории при отмене возврата.

### Готовые товары

#### createItem(Sku $sku, MarketplaceOrder $marketplaceOrder): void

**Описание:** Создает позицию заказа для нового товара.

#### hasReadyItem(Sku $sku): bool

**Описание:** Проверяет наличие готового товара на складе.

#### reserveReadyItem(Sku $sku, MarketplaceOrder $marketplaceOrder): void

**Описание:** Резервирует готовый товар для заказа.

### Дополнительные методы

#### getItemsForLabeling(Request $request): Collection

**Описание:** Получает товары для маркировки.

#### getMaxQuantityOrdersToUserRole()

**Описание:** Возвращает лимит заказов для роли пользователя.

#### getOrdersGroupedByMaterial(User $user): Collection

**Описание:** Группирует заказы по материалам для пользователя.

## Приватные методы

### Проверки и валидации

#### checkSchedule(): array

Проверяет рабочий день и время.

#### checkMaxStack(User $user): array

Проверяет лимит заказов у пользователя.

#### checkCutterDailyLimit(User $user): array

Проверяет дневной лимит метража для закройщиков.

#### hasMaterialsInWorkshop($marketplaceOrderItem): bool

Проверяет наличие всех необходимых материалов в цеху.

#### canUseMaterial(MarketplaceOrderItem $marketplaceOrderItem): bool

Проверяет доступ пользователя к материалам заказа.

#### isReserved($marketplaceOrderItem): bool

Проверяет, не зарезервирован ли заказ другим пользователем.

### Управление резервированием

#### reserve($marketplaceOrderItem): void

Устанавливает статус 99 (в резерве).

#### restoreReserve($marketplaceOrderItem): void

Восстанавливает статус после ошибки.

### Вспомогательные методы

#### getFilteredItems(): Collection

Получает отфильтрованный список заказов с учетом приоритетов.

#### processAvailableItems(): array

Обрабатывает доступные заказы.

#### tryProcessItem($marketplaceOrderItem): array

Пытается обработать конкретный заказ.

#### notifyNoMaterials($item): void

Уведомляет об отсутствии материалов.

#### notifyAboutReservation($marketplaceOrderItem, $item): void

Отправляет уведомления о резервировании.

#### getCutterMetersByStatus(int $status): float

Считает метраж для закройщика.

## Используемые модели и их связи

- **MarketplaceOrderItem:**
    - `status` - статусы 0, 3, 4, 5, 7, 8, 11, 13, 99
    - `seamstress_id` - швея
    - `cutter_id` - закройщик
    - `marketplace_order_id` - заказ
    - `marketplace_item_id` - товар
    - `shelf_id` - полка хранения

- **MovementMaterial:**
    - Создается при назначении заказа (type_movement = 3)

- **MarketplaceOrderHistory:**
    - Хранит историю возвратов

## Бизнес-правила и алгоритмы

### Приоритеты заказов:

1. **Персональные приоритеты:**
    - `fbo` - только FBO заказы
    - `fbo_200` - FBO заказы шириной 200 см

2. **Глобальные приоритеты (настройки):**
    - `ozon` - сначала Ozon
    - `wb` - сначала Wildberries

### Статусы жизненного цикла:

1. `0` (new) - новый заказ
2. `7` (cutting) - в раскрое
3. `8` (cut) - раскроен
4. `4` (in_work) - в работе у швеи
5. `5` (labeling) - маркировка
6. `3` (done) - выполнен
7. `11` - на складе
8. `13` - в сборке

### Расчет рейтинга:

```
Рейтинг = Σ(количество × ширина/100) / Σ(количество)
```

### Резервирование материалов:

- При назначении заказа материалы резервируются
- При отмене резерва освобождаются
- Учитывается тип материала и роль сотрудника

## Особенности реализации

1. **Ролевая модель:** Разная логика для швей и закройщиков
2. **Конкурентный доступ:** Механизм резервирования статуса 99
3. **Асинхронные уведомления:** Использование Job очередей
4. **Гибкие приоритеты:** Настраиваемые приоритеты заказов
5. **История заказов:** Полное отслеживание жизненного цикла
6. **Математические расчеты:** Точные расчеты рейтингов и лимитов

## Потенциальные проблемы

1. **Сложность:** Более 900 строк в одном классе
2. **Магические числа:** Статусы захардкожены
3. **N+1 запросы:** Возможны при загрузке связей
4. **Конкурентный доступ:** Состояние гонки при резервировании
5. **Смешанные ответственности:** Бизнес-логика и уведомления

## Рекомендации по улучшению

1. **Разделение:** Разбить на smaller сервисы по ответственности
2. **Константы:** Вынести статусы в enum
3. **Events:** Вынести уведомления в события
4. **Optimization:** Оптимизировать запросы к БД
5. **Caching:** Закэшировать частые запросы
6. **Testing:** Покрыть тестами критические методы

## Дата последнего изменения

2025-12-05
