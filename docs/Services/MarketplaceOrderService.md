# MarketplaceOrderService

## Назначение сервиса и его основная ответственность

Сервис `MarketplaceOrderService` управляет заказами с маркетплейсов (Ozon,
Wildberries и др.). Отвечает за создание, фильтрацию и обработку заказов из
различных маркетплейсов, включая управление статусами, группировку и проверку
состояния отгрузки.

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- `App\Http\Requests\StoreMarketplaceOrderRequest` - валидация запросов на
  создание заказа
- `App\Models\MarketplaceOrder` - основная модель заказов маркетплейсов
- `App\Models\MarketplaceOrderItem` - модель позиций в заказах
- `App\Models\MarketplaceSupply` - модель поставок с маркетплейсов
- `App\Models\Shelf` - модель полок для хранения товаров
- `Illuminate\Database\Eloquent\Builder` и `Collection` - для типизации
- `Illuminate\Support\Facades\DB` - для транзакций
- `Illuminate\Support\Facades\Log` - для логирования
- `Throwable` - для обработки исключений

## Публичные методы

### store(StoreMarketplaceOrderRequest $request): bool|RedirectResponse

**Описание:** Создает новый заказ(ы) с маркетплейса с учетом типа выполнения (
FBO/FBS).

**Параметры:**

- `$request` - валидированный запрос с данными заказа

**Возвращает:**

- `bool` - `true` при успешном создании
- `RedirectResponse` - при ошибке валидации

**Бизнес-логика:**

1. Проверяет наличие товаров и количеств в запросе
2. Использует транзакцию для обеспечения целостности данных
3. **Для FBO (Fulfilment by Owner):**
    - Создает N отдельных заказов, где N = количество товаров
    - К каждому order_id добавляется суффикс "-N"
4. **Для FBS (Fulfilment by Seller):**
    - Создает один заказ с указанным количеством
5. Логирует создание заказа в ERP канал

### getMarketplaceName(string $marketplace_id): string

**Описание:** Возвращает название маркетплейса по его ID.

**Параметры:**

- `$marketplace_id` - ID маркетплейса

**Возвращает:** `string` - название маркетплейса ('OZON', 'WB', '---')

**Поддерживаемые маркетплейсы:**

- ID '1' → 'OZON'
- ID '2' → 'WB' (Wildberries)

### pickupOrders(): Builder

**Описание:** Возвращает запрос для получения заказов со статусом "готов к
выдаче" (status = 13).

**Возвращает:** `Builder` - построитель запросов для фильтрации заказов

### groupPickupOrders($orders): array

**Описание:** Группирует заказы для выдачи по товарам и полкам хранения.

**Параметры:**

- `$orders` - коллекция заказов

**Возвращает:** `array` - сгруппированные данные о заказах

**Структура возвращаемого массива:**

```php
[
    'order_id' => [
        'itemName' => 'Название товара Ширина×Высота',
        'shelfStats' => [
            (object) [
                'shelf' => Shelf model,
                'quantity' => количество на полке
            ]
        ]
    ]
]
```

**Алгоритм работы:**

1. Для каждого заказа получает модель товара
2. Ищет все позиции этого товара со статусами [11, 13]
3. Группирует по полкам хранения
4. Считает количество товаров на каждой полке

### assembledOrders(): Collection

**Описание:** Возвращает сборочные заказы (status = 5), у которых все позиции
готовы к выдаче (status = 13).

**Возвращает:** `Collection` - коллекция заказов, готовых к сборке

### hasShippedOrdersBySupply(MarketplaceSupply $marketplace_supply): bool

**Описание:** Проверяет, есть ли в поставке заказы с некорректным статусом
отгрузки.

**Параметры:**

- `$marketplace_supply` - модель поставки

**Возвращает:** `bool` - `true` если есть заказы с неправильным статусом

**Бизнес-логика:**

1. Определяет ожидаемый статус в зависимости от маркетплейса:
    - Ozon (ID 1): 'awaiting_deliver'
    - Wildberries (ID 2): 'confirm'
2. Ищет заказы со статусом ОТЛИЧНЫМ от ожидаемого
3. Если такие заказы найдены - логирует ошибку и возвращает `true`

## Используемые модели и репозитории

- **MarketplaceOrder** - основная модель заказов
- **MarketplaceOrderItem** - позиции в заказах
- **MarketplaceSupply** - поставки с маркетплейсов
- **Shelf** - полки хранения товаров

## Обработка ошибок и исключения

1. **В методе store:**
    - Полная обработка ошибок через try-catch
    - Откат транзакции при любых ошибках
    - Возвращает `false` при неудаче
2. **Валидация данных:**
    - Проверка наличия товаров и количеств перед созданием
    - Возврат с ошибкой валидации если данные некорректны

## Интеграция с другими сервисами

Прямых интеграций с другими сервисами нет, но сервис использует:

- Статические вызовы других моделей для получения данных
- Систему логирования Laravel

## Бизнес-правила и алгоритмы

### Типы исполнения заказов:

1. **FBO (Fulfilment by Owner):**
    - Каждый товар создается как отдельный заказ
    - Добавляется суффикс "-N" к order_id
2. **FBS (Fulfilment by Seller):**
    - Один заказ на все товары

### Статусы заказов:

- `0` - новый заказ
- `5` - собран
- `11` - частично готов
- `13` - готов к выдаче

### Алгоритм проверки поставок:

1. Получить все заказы привязанные к поставке
2. Проверить статус каждого заказа в системе маркетплейса
3. Сравнить с ожидаемым статусом для данного маркетплейса
4. При несоответствии - логировать ошибку

## Особенности реализации

1. **Транзакционная целостность:** Все операции создания заказов обернуты в
   транзакции
2. **Логирование:** Все важные операции логируются в специальный канал 'erp'
3. **Гибкая обработка FBO:** Автоматическое создание множества заказов при
   необходимости
4. **Использование match expression:** Современный синтаксис для определения
   статусов и названий маркетплейсов
5. **Сложная группировка:** Умная группировка заказов по товарам и местам
   хранения

## Потенциальные проблемы и рекомендации

1. **Производительность:** Метод `groupPickupOrders` выполняет много запросов в
   цикле
    - Рекомендация: использовать eager loading и batch queries
2. **Магические числа:** Статусы захардкожены (0, 5, 11, 13)
    - Рекомендация: вынести в константы или enum
3. **Обработка исключений:** Метод может бросать исключения которые не
   обрабатываются
    - Рекомендация: добавить более детальную обработку

## Дата последнего изменения

2025-12-05
