# MarketplaceApiService

## Назначение сервиса и его основная ответственность

Сервис `MarketplaceApiService` является ключевым компонентом для интеграции с
API маркетплейсов (Ozon и Wildberries). Отвечает за:

- Получение товаров и заказов с маркетплейсов
- Управление статусами заказов
- Создание и управление поставками
- Генерация штрихкодов и этикеток
- Обработка отмененных заказов
- Интеграцию с внутренними системами ERP

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора. Используемые импорты и зависимости:

- **Jobs:**
    - `SendTelegramMessageJob` - для асинхронной отправки уведомлений
- **Models:**
    - `MarketplaceOrder` - заказы маркетплейсов
    - `MarketplaceOrderItem` - позиции в заказах
    - `MarketplaceSupply` - поставки
    - `MovementMaterial` - перемещения материалов
    - `Order` - внутренние заказы
    - `Setting` - настройки системы
    - `Sku` - SKU товаров
- **HTTP клиент:**
    - `Illuminate\Http\Client\PendingRequest`
    - `Illuminate\Support\Facades\Http`
- **PDF генерация:**
    - `Barryvdh\DomPDF\Facade\Pdf`
- **Вспомогательные классы:**
    - `Carbon` - работа с датами
    - `DB` - транзакции
    - `Log` - логирование
    - `Response` - HTTP ответы
    - `Throwable` - обработка исключений

## Публичные методы

### Управление товарами

#### getItemsWb($body = 0): object|false|null

**Описание:** Получает список товаров с Wildberries.
**Возвращает:** Объект с товарами или `false` при ошибке

#### getAllItemsWb(): array

**Описание:** Получает все товары с Wildberries с пагинацией.
**Возвращает:** Массив товаров в унифицированном формате

#### getItemsOzon($body = 0): object|false|null

**Описание:** Получает список товаров с Ozon.
**Возвращает:** Объект с товарами или `false` при ошибке

#### getAllItemsOzon(): array

**Описание:** Получает все товары с Ozon с пагинацией.
**Возвращает:** Массив товаров в унифицированном формате

#### getNotFoundSkus($allItems): array

**Описание:** Находит SKU, которых нет в системе.
**Параметры:** `$allItems` - массив товаров с маркетплейса
**Возвращает:** Массив не найденных SKU

### Управление заказами

#### getAllNewOrdersWb(): array|object

**Описание:** Получает новые заказы с Wildberries.
**Возвращает:** Унифицированный массив заказов

#### getAllNewOrdersOzon(): array|object

**Описание:** Получает новые заказы с Ozon.
**Возвращает:** Унифицированный массив заказов

#### uploadingNewProducts(): array

**Описание:** Основной метод загрузки новых заказов в систему.
**Бизнес-логика:**

1. Получает новые заказы с обоих маркетплейсов
2. Разделяет заказы с количеством > 1
3. Проверяет наличие SKU в системе
4. Создает заказы и позиции
5. Резервирует товары если они готовы
6. Отправляет уведомления в Telegram

**Возвращает:**

```php
[
    'not_found_skus' => [], // SKU которых нет в системе
    'errors' => [] // ошибки обработки
]
```

#### splittingOrder($order): bool

**Описание:** Разделяет заказ Ozon с несколькими товарами на отдельные.
**Параметры:** `$order` - заказ для разделения
**Возвращает:** `true` при успешном разделении

### Управление отмененными заказами

#### uploadingCancelledProducts(): array

**Описание:** Основной метод обработки отмененных заказов.
**Бизнес-логика:**

1. Получает отмененные заказы с обоих маркетплейсов
2. Обрабатывает в зависимости от статуса в системе
3. Удаляет заказы или меняет тип на FBO

**Возвращает:** Массив результатов обработки

### Управление сборкой заказов

#### collectOrderOzon($orderId, $product): bool

**Описание:** Отправляет заказ Ozon в сборку.
**Параметры:**

- `$orderId` - ID заказа
- `$product` - SKU продукта

**Возвращает:** `true` при успешной отправке

#### collectOrderWb($orderId): bool

**Описание:** Добавляет заказ Wildberries в поставку.
**Параметры:** `$orderId` - ID заказа
**Возвращает:** `true` при успешном добавлении

### Генерация штрихкодов

#### getBarcodeOzon($orderId): object|false|null

**Описание:** Генерирует PDF со штрихкодом для заказа Ozon.

#### getBarcodeWb($orderId): object|false|null

**Описание:** Генерирует PDF со штрихкодом для заказа Wildberries.

#### getBarcodeOzonFBO(MarketplaceOrder $order): \Illuminate\Http\Response

**Описание:** Генерирует этикетку для FBO заказа Ozon с информацией о швее.

### Управление поставками

#### ozonSupply(MarketplaceSupply $marketplace_supply): bool

**Описание:** Создает и отправляет поставку в Ozon.
**Бизнес-логика:**

1. Создает новую поставку
2. Добавляет заказы в поставку
3. Отправляет в доставку

#### wbSupply(MarketplaceSupply $marketplace_supply): bool

**Описание:** Создает и отправляет поставку в Wildberries.
**Бизнес-логика:**

1. Создает новую поставку
2. Добавляет заказы в поставку
3. Отправляет в доставку

#### getDocsSupplyOzon(MarketplaceSupply $marketplace_supply)

**Описание:** Получает PDF документ (акт приема-передачи) для поставки Ozon.

#### getBarcodeSupplyOzon(MarketplaceSupply $marketplace_supply)

**Описание:** Получает PDF со штрихкодом для поставки Ozon.

#### getBarcodeSupplyWB(MarketplaceSupply $marketplace_supply)

**Описание:** Получает PDF со штрихкодом для поставки Wildberries.

### Обновление статусов

#### updateStatusOrderBySupplyWB(MarketplaceSupply $marketplace_supply): bool

**Описание:** Обновляет статусы всех заказов в поставке Wildberries.

#### updateStatusOrderBySupplyOzon(MarketplaceSupply $marketplace_supply): bool

**Описание:** Обновляет статусы всех заказов в поставке Ozon.

#### getStatusOrder(MarketplaceOrder $order)

**Описание:** Получает текущий статус заказа с маркетплейса.

### Вспомогательные методы

#### getOzonPostingNumberByBarcode($barcode): array|string

**Описание:** Находит номер заказа Ozon по штрихкоду товара.

#### getOzonPostingNumberByReturnBarcode($barcode): array|string

**Описание:** Находит номер заказа Ozon по штрихкоду возврата.

#### getReturnReason(MarketplaceOrderItem $marketplace_item): string

**Описание:** Получает причину возврата заказа.

## Приватные методы

### HTTP клиенты

#### wbRequest(): PendingRequest

**Описание:** Создает HTTP клиент для запросов к Wildberries API.
**Настройки:**

- Отключает верификацию SSL
- Добавляет заголовок авторизации

#### ozonRequest(): PendingRequest

**Описание:** Создает HTTP клиент для запросов к Ozon API.
**Настройки:**

- Отключает верификацию SSL
- Добавляет заголовки Client-Id и Api-Key

### Управление ключами API

#### getWbApiKey(): string

#### getOzonApiKey(): string

#### getOzonSellerId(): string

**Описание:** Получают ключи и ID из таблицы настроек.

### Проверки статусов

#### hasOrderInSystem($id): bool

**Описание:** Проверяет существование заказа в системе.

#### hasSkuInSystem($sku): ?Sku

**Описание:** Ищет SKU в базе данных.

#### verifyOrFixExemplarStatus($orderId): bool

**Описание:** Проверяет и исправляет статус экземпляра товара в заказе Ozon.

## Используемые модели и репозитории

- **MarketplaceOrder** - основная модель для заказов
- **MarketplaceOrderItem** - позиции в заказах
- **MarketplaceSupply** - поставки
- **Sku** - артикулы товаров
- **Setting** - настройки системы (хранение API ключей)
- **MovementMaterial** - перемещения материалов
- **Order** - внутренние заказы системы

## Интеграция с другими сервисами

- **TgService:** Отправка уведомлений в Telegram
- **UserService:** Получение списков сотрудников для уведомлений
- **MarketplaceOrderItemService:** Управление позициями заказов
- **SendTelegramMessageJob:** Асинхронная отправка сообщений

## Обработка ошибок и исключения

1. **Логирование:** Все ошибки логируются в специальный канал `marketplace_api`
2. **Try-Catch:** Критические операции обернуты в try-catch блоки
3. **Проверка ответов:** Проверяется HTTP статус ответа API
4. **Транзакции:** Операции с БД обернуты в транзакции
5. **Graceful degradation:** При ошибках возвращаются значения по умолчанию

## Бизнес-правила и алгоритмы

### Процесс загрузки новых заказов:

1. **Получение заказов:** С обоих маркетплейсов
2. **Фильтрация:** Исключение уже существующих заказов
3. **Валидация SKU:** Проверка наличия товаров в системе
4. **Разделение:** Заказы с количеством > 1 разделяются
5. **Создание:** Создание заказов и позиций в БД
6. **Резервирование:** Если товар готов - резервируем его
7. **Уведомления:** Отправка уведомлений ответственным сотрудникам

### Процесс обработки отмен:

1. **Получение статусов:** С обоих маркетплейсов
2. **Сопоставление:** Поиск заказов в системе
3. **Обработка:**
    - Статус 0: Удаление заказа
    - Статус 4,5,7,8: Смена на FBO
    - Статус 13: Восстановление товара и удаление

### Управление поставками:

1. **Создание поставки** на маркетплейсе
2. **Добавление заказов** в поставку
3. **Передача в доставку**
4. **Получение документов** и штрихкодов

## Особенности реализации

1. **Унификация формата:** Заказы с разных маркетплейсов приводятся к единому
   формату
2. **Асинхронные уведомления:** Использование Job очередей для отправки в
   Telegram
3. **PDF генерация:** Встроенная генерация этикеток и документов
4. **Кэширование ключей API:** Ключи хранятся в БД и кэшируются
5. **Обработка пагинации:** Правильная обработка постраничной загрузки данных
6. **Robust error handling:** Многоуровневая обработка ошибок

## Потенциальные проблемы

1. **Rate limiting:** Нет контроля за лимитами API
2. **SSL verification:** Отключена верификация SSL (безопасность)
3. **Magic numbers:** Множество захардкоженных чисел (статусы, лимиты)
4. **Синхронные запросы:** Все запросы выполняются синхронно
5. **Большой класс:** Более 1900 строк кода в одном классе

## Рекомендации по улучшению

1. Разделить на меньшие классы по ответственности
2. Вынести константы в отдельный класс
3. Добавить кэширование запросов к API
4. Реализовать асинхронную обработку с очередями
5. Добавить retry механизмы для API запросов
6. Улучшить типизацию возвращаемых значений
7. Добавить юнит-тесты

## Дата последнего изменения

2025-12-05
