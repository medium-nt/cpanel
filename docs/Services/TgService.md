# TgService

## Назначение сервиса и его основная ответственность

Сервис `TgService` предоставляет интерфейс для отправки сообщений в Telegram.
Основная ответственность - абстрагировать логику отправки сообщений и обеспечить
работу в различных окружениях (production/development).

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- `GuzzleHttp\Client` - HTTP клиент для прямых запросов к Telegram API
- `Illuminate\Support\Facades\Log` - для логирования ошибок
- `Telegram\Bot\Laravel\Facades\Telegram` - основной фасад для работы с Telegram
  в Laravel

## Публичные методы

### sendMessage($chatId, $message): void

**Описание:** Отправляет сообщение в указанный чат Telegram.

**Параметры:**

- `$chatId` (mixed) - ID чата, куда будет отправлено сообщение
- `$message` (string) - Текст сообщения для отправки

**Возвращает:** `void`

**Бизнес-логика:**

1. **Проверка chatId:** Если `$chatId` пустой или falsy, метод завершается без
   выполнения
2. **Определение окружения:**
    - **Development:** Использует прямой HTTP запрос через Guzzle
    - **Production:** Использует Laravel Telegram фасад
3. **Обработка ошибок:** В production ошибки логируются в специальный канал
   `tg_api`

## Особенности реализации

### Разделение логики по окружениям:

#### Development окружение:

- Использует Guzzle HTTP клиент
- Отключает верификацию SSL сертификатов
- Устанавливает таймауты 30 секунд
- Прямой запрос к Telegram API endpoint

```php
$client->post('https://api.telegram.org/bot' . config('telegram.bots.mybot.token') . '/sendMessage', [
    'form_params' => [
        'chat_id' => $chatId,
        'text' => $message,
    ],
]);
```

#### Production окружение:

- Использует Telegram Laravel SDK
- Обернут в try-catch для обработки исключений
- При ошибке логирует chat_id и сообщение об ошибке

```php
Telegram::sendMessage([
    'chat_id' => $chatId,
    'text' => $message,
]);
```

## Используемые модели и репозитории

Сервис не использует модели или репозитории напрямую. Работает с конфигурацией
Laravel:

- `config('telegram.bots.mybot.token')` - токен бота

## Интеграция с другими сервисами

Сервис используется другими сервисами для отправки уведомлений:

- `MarketplaceApiService` - уведомления о новых заказах
- Другие компоненты системы для информирования пользователей

## Обработка ошибок и исключения

1. **Валидация входных данных:** Проверка на пустой `$chatId`
2. **Production ошибки:**
    - Все исключения ловятся через `catch (\Throwable $e)`
    - Логирование в канал `tg_api`
    - Записывается chat_id и текст ошибки
3. **Development окружение:** Нет обработки ошибок (может привести к
   необработанным исключениям)

## Бизнес-правила и алгоритмы

### Алгоритм отправки сообщения:

1. **Валидация:** Проверить наличие chat_id
2. **Определить окружение:** Проверить `app()->environment('production')`
3. **Выбор метода отправки:**
    - Development → Guzzle
    - Production → Telegram SDK
4. **Отправить сообщение**
5. **Обработать ошибки** (только в production)

## Потенциальные проблемы

1. **Безопасность:** Отключение SSL верификации в development окружении
2. **Обработка ошибок:** В development режиме ошибки не обрабатываются
3. **Timeout:** Жестко заданные таймауты могут быть недостаточны при медленном
   соединении
4. **Магические строки:** `'tg_api'` - имя канала логирования захардкожено
5. **Ограничения Telegram:** Нет контроля над лимитами API (30 сообщений в
   секунду)

## Рекомендации по улучшению

1. **Единый метод:** Использовать один и тот же подход для всех окружений
2. **Retry механизм:** Добавить повторные попытки при неудачной отправке
3. **Rate limiting:** Реализовать контроль лимитов API
4. **Асинхронная отправка:** Использовать очереди для отправки сообщений
5. **Конфигурация таймаутов:** Вынести таймауты в конфигурацию
6. **Типизация:** Добавить строгую типизацию параметров
7. **Логирование всех попыток:** Логировать и успешные отправки для аудита

## Пример использования

```php
// Отправка уведомления администратору
TgService::sendMessage(config('telegram.admin_id'), 'Новый заказ поступил в систему');

// Отправка уведомления сотруднику
TgService::sendMessage($user->telegram_id, 'Вам назначен новый заказ');
```

## Дата последнего изменения

2025-12-05
