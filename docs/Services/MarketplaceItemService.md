# MarketplaceItemService

## Назначение сервиса и его основная ответственность

Сервис `MarketplaceItemService` управляет товарами маркетплейсов в системе.
Основные задачи:

- Фильтрация и поиск товаров
- Управление SKU для разных маркетплейсов
- Настройка расхода материалов на производство товаров
- Предоставление справочных данных (уникальные значения полей)

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Form Requests:**
    - `SaveMarketplaceItemRequest` - валидация данных сохранения
- **Models:**
    - `MarketplaceItem` - товары маркетплейсов
    - `MaterialConsumption` - нормы расхода материалов
    - `Sku` - SKU товаров
- **Laravel:**
    - `Collection` - для возвращаемых коллекций
    - `Request` - HTTP запросы

## Публичные методы

### getFilteredItems(Request $request): Builder

**Описание:** Формирует запрос для фильтрации товаров маркетплейсов.

**Параметры фильтрации:**

- `title` - поиск по названию (LIKE)
- `width` - точная ширина товара

**Возвращает:** `Illuminate\Database\Eloquent\Builder`

**Пример использования:**

```php
$query = MarketplaceItemService::getFilteredItems($request);
$items = $query->paginate(15);
```

### saveSkus(MarketplaceItem $marketplaceItem, SaveMarketplaceItemRequest|Request $request): void

**Описание:** Сохраняет SKU для товара на разных маркетплейсах.

**Поддерживаемые маркетплейсы:**

- Ozon (ID: 1) - поле `ozon_sku`
- Wildberries (ID: 2) - поле `wb_sku`

**Логика работы:**

1. Для каждого маркетплейса проверяет заполненность SKU
2. Использует `updateOrCreate` для создания или обновления записи
3. Создает связь товар → маркетплейс → SKU

**Пример сохранения:**

```php
// Если заполнены ozon_sku и wb_sku:
// Создаст/обновит 2 записи в таблице skus
```

### saveMaterialsConsumption(MarketplaceItem $marketplaceItem, SaveMarketplaceItemRequest|Request $request): void

**Описание:** Сохраняет нормы расхода материалов для производства товара.

**Параметры из запроса:**

- `material_id[]` - массив ID материалов
- `quantity[]` - массив соответствующих количеств

**Логика работы:**

1. Проверяет наличие материалов в запросе
2. Для каждого материала с количеством > 0:
    - Создает или обновляет запись в `MaterialConsumption`
    - Связывает товар с материалом и его нормой расхода

**Особенности:**

- Пропускает материалы с нулевым количеством
- Использует `updateOrCreate` для атомарности операции

### getAllTitleMaterials(): Collection

**Описание:** Возвращает уникальный отсортированный список названий всех
товаров.

**Возвращает:** `Collection` с полями `title`

**SQL эквивалент:**

```sql
SELECT DISTINCT title FROM marketplace_items ORDER BY title
```

### getAllWidthMaterials(): Collection

**Описание:** Возвращает уникальный отсортированный список ширин всех товаров.

**Возвращает:** `Collection` с полями `width`

**SQL эквивалент:**

```sql
SELECT DISTINCT width FROM marketplace_items ORDER BY width
```

### getAllHeightMaterials(): Collection

**Описание:** Возвращает уникальный отсортированный список высот всех товаров.

**Возвращает:** `Collection` с полями `height`

**SQL эквивалент:**

```sql
SELECT DISTINCT height FROM marketplace_items ORDER BY height
```

## Используемые модели и репозитории

- **MarketplaceItem:** Основная модель товаров
    - Поля: `title`, `width`, `height`
- **Sku:** Артикулы товаров на маркетплейсах
    - Связи: `item_id`, `marketplace_id`, `sku`
- **MaterialConsumption:** Нормы расхода материалов
    - Связи: `item_id`, `material_id`, `quantity`

## Интеграция с другими сервисами

Сервис является самодостаточным и не вызывает другие сервисы напрямую.
Используется другими компонентами системы для управления товарами.

## Обработка ошибок и исключения

1. **Валидация:** Через Form Request на уровне контроллера
2. **Атомарность:** Использование `updateOrCreate` обеспечивает консистентность
3. **Null safety:** Проверка наличия данных перед обработкой

## Бизнес-правила и алгоритмы

### Правила работы с SKU:

1. Один товар может иметь SKU на разных маркетплейсах
2. SKU уникальны в рамках пары (товар, маркетплейс)
3. Пустые SKU не сохраняются

### Правила расхода материалов:

1. Один товар может требовать несколько материалов
2. Количество должно быть > 0
3. Норма расхода уникальна для пары (товар, материал)

### Справочники:

- Все методы справочников возвращают отсортированные данные
- Используется DISTINCT для получения уникальных значений

## Особенности реализации

1. **Универсальность:** Методы принимают разные типы запросов (Request |
   SaveMarketplaceItemRequest)
2. **Гибкость:** Поддержка множества маркетплейсов через конфигурацию
3. **Оптимизация:** Использование DISTINCT для справочников
4. **Атомарность:** `updateOrCreate` предотвращает дубликаты

## Потенциальные проблемы

1. **Hardcoded маркетплейсы:** Список захардкожен в методе
2. **Нет валидации количества:** Отрицательные значения не проверяются
3. **Нет кэширования:** Справочники запрашиваются каждый раз
4. **N+1 проблема:** При обработке связанных данных

## Рекомендации по улучшению

1. **Конфигурация:** Вынести список маркетплейсов в конфиг
2. **Валидация:** Добавить проверку на отрицательные значения
3. **Кэширование:** Закэшировать справочники названий/размеров
4. **Batch операции:** Использовать массовое сохранение для SKU
5. **Events:** Добавить события для аудита изменений

## Пример использования

```php
// Фильтрация товаров
$items = MarketplaceItemService::getFilteredItems($request)
    ->paginate(20);

// Сохранение SKU
MarketplaceItemService::saveSkus($item, $request);

// Сохранение норм расхода
MarketplaceItemService::saveMaterialsConsumption($item, $request);

// Получение справочников
$titles = MarketplaceItemService::getAllTitleMaterials();
$widths = MarketplaceItemService::getAllWidthMaterials();
```

## Дата последнего изменения

2025-12-05
