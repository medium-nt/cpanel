# DefectMaterialService

## Назначение сервиса и его основная ответственность

Сервис `DefectMaterialService` управляет процессом оформления бракованных
материалов и остатков в производственном процессе. Основные задачи:

- Создание заявлений на брак и остатки
- Обработка статусов заявок (одобрение/отмена)
- Управление передачей брака на склад
- Удаление необработанных заявок
- Уведомление ответственных лиц через Telegram

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Form Requests:**
    - `SaveDefectMaterialRequest` - валидация данных брака
- **Jobs:**
    - `SendTelegramMessageJob` - асинхронная отправка уведомлений
- **Models:**
    - `MovementMaterial` - перемещения материалов
    - `Order` - заказы системы
- **Laravel Facades:**
    - `DB` - для транзакций
    - `Log` - для логирования
- **Services:**
    - `TgService` - прямая отправка сообщений
    - `UserService` - для получения списков сотрудников

## Публичные методы

### save(Request $request, Order $order): false|array

**Описание:** Обрабатывает изменение статуса заявки на брак/остатки.

**Параметры:**

- `$request` - запрос с новым статусом
- `$order` - заказ на брак/остатки

**Поддерживаемые статусы и типы:**

- Тип 4 → "брак"
- Тип 7 → "остаток"

**Обрабатываемые статусы:**

- `-1` - отмена заявки
- `1` - одобрение заявки
- `3` - прием на склад кладовщиком

**Возвращает массив:**

```php
[
    'status' => 'success'|'error',
    'text' => 'одобрен'|'отменен'|'принят на складе'
]
```

**Логика обработки:**

1. Определяет тип операции (брак/остаток)
2. Формирует описание операции
3. В зависимости от статуса:
    - **-1:** Логирует отмену
    - **1:** Логирует одобрение
    - **3:** Отправляет уведомления швеям и админу

**Пример уведомления при приеме:**

```
Кладовщик [Имя] забрал брак с производства:
• Материал1 5 шт
```

### store(SaveDefectMaterialRequest $request): bool

**Описание:** Создает новую заявку на брак или остатки.

**Параметры запроса:**

- `material_id[]` - массив ID материалов
- `ordered_quantity[]` - массив количеств
- `type_movement_id` - тип (4 - брак, 7 - остатки)
- `comment` - комментарий

**Бизнес-логика:**

1. **Валидация:**
    - Для остатков (type=7) количество должно быть ≤ 1
    - Проверка на пустые значения

2. **Создание заказа:**
    - Определение поля по роли (швея/закройщик)
    - Создание заказа с type_movement = 4 или 7
    - Статус 0 - новая заявка

3. **Формирование уведомлений:**
    - Список материалов для отправки
    - Асинхронная отправка администратору
    - Последовательная отправка кладовщикам с задержкой

**Пример уведомления:**

```
Сотрудник [Имя] указал брак:
• Материал1 2 м
• Материал2 1 шт
```

### delete(Order $order): array

**Описание:** Удаляет заявку на брак/остатки.

**Условия удаления:**

- Статус заказа должен быть 1 (одобрен)
- Нельзя удалить уже принятый на склад заказ

**Возвращает массив:**

```php
[
    'success' => bool,
    'message' => 'Заказ на брак удален' | 'Заказ уже забран на склад!' | 'Внутренняя ошибка'
]
```

**Процесс удаления:**

1. Проверка статуса
2. Удаление связанных MovementMaterial
3. Удаление самого заказа
4. Все операции в транзакции

## Используемые модели и репозитории

- **Order:** Заказы системы
    - `type_movement = 4` - брак
    - `type_movement = 7` - остатки
    - `status = 0` - новая заявка
    - `status = 1` - одобрена
    - `status = 3` - принята на склад

- **MovementMaterial:** Детали перемещения
    - Связывает заказ с материалами и количествами

## Интеграция с другими сервисами

- **TgService:** Прямая отправка уведомлений (метод save)
- **UserService:** Получение списков сотрудников:
    - `getListStorekeepersWorkingToday()` - кладовщики
    - `getListSeamstressesWorkingToday()` - швеи
- **SendTelegramMessageJob:** Асинхронная отправка (метод store)

## Обработка ошибок и исключения

1. **Транзакции:** Все операции обернуты в DB::transaction
2. **Валидация:** Через Form Request и бизнес-правила
3. **Rollback:** При любой ошибке происходит откат
4. **Возврат статуса:** Для обработки на уровне контроллера
5. **Логирование:** Все операции логируются в канал 'erp'

## Бизнес-правила и алгоритмы

### Процесс оформления брака/остатков:

1. **Создание заявки:**
    - Сотрудник (швея/закройщик) указывает материалы
    - Создается заказ со статусом "новая"
    - Уведомляются кладовщики

2. **Обработка заявки:**
    - Администратор одобряет или отменяет
    - Одобренные заявки передаются на склад
    - Отклоненные просто логируются

3. **Прием на склад:**
    - Кладовщик забирает материалы
    - Статус меняется на "принят"
    - Уведомляются швеи

### Ограничения:

- Остатки (type=7) можно указывать только в количестве 1
- Нельзя удалить уже принятые на склад материалы
- Только швеи и закройщики могут создавать заявки

## Особенности реализации

1. **Ролевая модель:** Автоматическое определение поля по роли
2. **Асинхронные уведомления:** Использование Job очередей
3. **Задержка отправки:** Последовательная отправка с задержкой
4. **Типизация:** Современный match expression
5. **Полный цикл:** От создания до удаления

## Потенциальные проблемы

1. **Жесткие типы:** type_movement захардкожен (4, 7)
2. **Ограничение остатков:** Только количество = 1 (магическое правило)
3. **Нет аудита:** Не логируется кто и когда удалил заявку
4. **Прямое использование TgService:** Смешение синхронных/асинхронных вызовов

## Рекомендации по улучшению

1. **Константы:** Вынести типы перемещений в enum
2. **Events:** Добавить события для аудита всех действий
3. **Единый подход:** Использовать только Job для уведомлений
4. **Валидация:** Вынести бизнес-правила в Request класс
5. **Soft deletes:** Вместо физического удаления использовать мягкое

## Пример использования

```php
// Создание заявки на брак
$success = DefectMaterialService::store($request);

// Обработка статуса
$result = DefectMaterialService::save($request, $order);

// Удаление заявки
$result = DefectMaterialService::delete($order);
```

## Дата последнего изменения

2025-12-05
