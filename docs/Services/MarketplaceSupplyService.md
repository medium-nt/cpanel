# MarketplaceSupplyService

## Назначение сервиса и его основная ответственность

Сервис `MarketplaceSupplyService` управляет дополнительными функциями поставок с
маркетплейсов. Основные задачи:

- Обработка загрузки видео для поставок (чанкованная загрузка)
- Автоматическая очистка старых видео файлов
- Управление временными файлами при загрузке

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Models:**
    - `MarketplaceSupply` - модель поставок с маркетплейсов
- **Laravel компоненты:**
    - `Illuminate\Http\JsonResponse` - для возврата JSON ответов
    - `Illuminate\Http\Request` - обработка HTTP запросов
    - `Illuminate\Support\Facades\Log` - логирование операций
    - `Illuminate\Support\Facades\Storage` - работа с файловой системой

## Публичные методы

### deleteOldVideos(): void

**Описание:** Удаляет видеофайлы поставок старше 60 дней.

**Бизнес-логика:**

1. Поиск поставок с видео старше 60 дней
2. Удаление видеофайлов из файлового хранилища
3. Очистка поля `video` в базе данных
4. Логирование каждой операции удаления

**Алгоритм:**

```php
// 1. Найти старые записи
$video = MarketplaceSupply::query()
    ->where('video', '!=', null)
    ->where('created_at', '<', now()->subDays(60))
    ->get();

// 2. Для каждой записи:
//    - Удалить файл из storage/public/videos/
//    - Обнулить поле video
//    - Залогировать операцию
```

**Логирование:**

- Запуск очистки: `Запускаем ежедневную очистку старых видео...`
- Удаление каждого файла: `Видео для поставки #ID удалено после 60 дней.`
- Завершение: `Очистка старых видео завершена.`

### chunkedUpload(Request $request): JsonResponse

**Описание:** Обрабатывает чанкованную загрузку видеофайлов (multipart upload).

**Параметры запроса:**

- `video` - загружаемый чанк файла
- `dzchunkindex` - индекс текущего чанка (0-based)
- `dztotalchunkcount` - общее количество чанков
- `dzuuid` - уникальный идентификатор загрузки
- `marketplace_supply_id` - ID поставки

**Возвращает:** `JsonResponse` со статусом операции

**Бизнес-логика:**

1. **Прием чанка:**
    - Сохранение чанка во временную директорию `chunks/{uuid}`
    - Имя файла чанка: `{index}.part`

2. **Сборка файла (когда все чанки получены):**
    - Создание временного потока в памяти
    - Последовательное чтение и объединение всех чанков
    - Сохранение итогового файла в `videos/`
    - Обновление записи в БД с именем файла

3. **Очистка:**
    - Удаление временной директории с чанками
    - Логирование успешной сборки

**Пример ответа при завершении загрузки:**

```json
{
    "status": "Видео загружено и собрано",
    "filename": "123.mp4"
}
```

**Пример ответа при приеме чанка:**

```json
{
    "status": "Чанк 5 сохранён"
}
```

## Используемые модели и репозитории

- **MarketplaceSupply:** Поставки с маркетплейсов
    - `video` - имя видеофайла
    - `created_at` - дата создания для проверки возраста файла

## Интеграция с другими сервисами

Сервис является самодостаточным и не имеет прямых зависимостей от других
сервисов. Использует встроенные возможности Laravel:

- Storage фасад для работы с файлами
- Log фасад для логирования

## Обработка ошибок и исключения

1. **Файловые операции:**
    - Проверка существования чанков перед сборкой
    - Логирование пропущенных чанков
    - Обработка ошибок чтения/записи файлов

2. **Валидация:**
    - Проверка наличия необходимых параметров запроса
    - Существование записи поставки в БД

3. **Очистка ресурсов:**
    - Автоматическое удаление временных файлов
    - Корректное закрытие файловых потоков

## Бизнес-правила и алгоритмы

### Процесс чанковой загрузки:

1. **Клиент делит файл на чанки** (обычно по 1-2 МБ)
2. **Каждый чанк отправляется отдельно** с метаданными
3. **Сервер сохраняет чанки** во временную папку
4. **Когда все чанки получены:**
    - Проверяется полнота набора
    - Чанки объединяются в правильном порядке
    - Итоговый файл сохраняется
    - Временные файлы удаляются

### Политика очистки:

- Видео удаляются автоматически через 60 дней
- Очистка запускается по расписанию (вероятно, через cron)
- Удаляются как файлы, так и ссылки на них в БД

## Особенности реализации

1. **Эффективная работа с памятью:**
    - Использование временных потоков
    - Чанкованная загрузка снижает нагрузку на сервер
    - Минимальное потребление RAM при сборке больших файлов

2. **Отказоустойчивость:**
    - Логирование пропущенных чанков
    - Возможность возобновления прерванной загрузки
    - Автоматическая очистка временных файлов

3. **Масштабируемость:**
    - Поддержка загрузки файлов любого размера
    - Возможность параллельной загрузки разных файлов

## Потенциальные проблемы

1. **Безопасность:**
    - Нет проверки типа файла (можно загрузить не видео)
    - Нет ограничений на размер файла
    - UUID не проверяется на уникальность

2. **Производительность:**
    - Большое количество дисковых операций
    - Нет контроля одновременных загрузок

3. **Обработка ошибок:**
    - Нет отката при частичной сборке файла
    - Нет таймаутов на операции с файлами

## Рекомендации по улучшению

1. **Безопасность:**
    - Добавить валидацию MIME типа
    - Установить лимит на размер файла
    - Проверять права доступа к поставке

2. **Надежность:**
    - Добавить механизм повторной сборки при ошибке
    - Реализовать проверку целостности файла (checksum)
    - Добавить таймауты для файловых операций

3. **Мониторинг:**
    - Логировать время загрузки каждого чанка
    - Добавить метрики размера загружаемых файлов
    - Мониторить использование дискового пространства

## Пример использования

```php
// Прием чанка от DropzoneJS
$response = MarketplaceSupplyService::chunkedUpload($request);

// Ежедневная очистка старых видео (в cron задаче)
MarketplaceSupplyService::deleteOldVideos();
```

## Дата последнего изменения

2025-12-05
