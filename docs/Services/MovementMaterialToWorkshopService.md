# MovementMaterialToWorkshopService

## Назначение сервиса и его основная ответственность

Сервис `MovementMaterialToWorkshopService` управляет процессом перемещения
материалов со склада в производственный цех. Отвечает за:

- Создание запросов на материалы от производственного персонала (швеи,
  закройщики)
- Обработку отгрузки материалов кладовщиком
- Учет списания материалов
- Уведомление ответственных лиц через Telegram

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Form Requests:**
    - `SaveCollectMovementMaterialToWorkshopRequest` - валидация сбора
      материалов
    - `SaveWriteOffMovementMaterialToWorkshopRequest` - валидация списания
    - `StoreMovementMaterialToWorkshopRequest` - валидация создания запроса
- **Models:**
    - `MovementMaterial` - перемещение материалов
    - `Order` - заказы системы
- **Laravel Facades:**
    - `DB` - для транзакций
    - `Log` - для логирования в ERP канал
- **Services:**
    - `TgService` - для отправки уведомлений
    - `UserService` - для получения списков сотрудников

## Публичные методы

### getOrdersByStatus($requestStatus): Builder

**Описание:** Получает запросы на перемещение материалов с фильтрацией по
статусу.

**Параметры:**

- `$requestStatus` - фильтр статуса ('all' или другие)

**Возвращает:** `Illuminate\Database\Eloquent\Builder`

**Логика фильтрации:**

- По умолчанию: статусы [0, 2] (новые и отгруженные)
- 'all': все статусы [-1, 0, 1, 2, 3]

### store(StoreMovementMaterialToWorkshopRequest $request): bool|RedirectResponse

**Описание:** Создает новый запрос на материалы со склада.

**Параметры:**

- `$request` - валидированные данные запроса

**Возвращает:**

- `bool` - `true` при успехе
- `RedirectResponse` - при ошибке валидации

**Бизнес-логика:**

1. Валидация наличия материалов и количеств
2. Определение роли пользователя (швея/закройщик)
3. Создание заказа с type_movement = 2
4. Создание позиций перемещения материалов
5. Формирование уведомления для Telegram
6. Отправка уведомлений администратору и кладовщикам

**Пример уведомления:**

```
Швея [Имя] запросила:
• Материал1 5 шт
• Материал2 3 м
```

### save_collect(SaveCollectMovementMaterialToWorkshopRequest $request, Order $order): bool|RedirectResponse

**Описание:** Фиксирует фактическую отгрузку материалов кладовщиком.

**Параметры:**

- `$request` - данные с фактическими количествами
- `$order` - заказ на перемещение

**Возвращает:**

- `bool` - `true` при успехе
- `RedirectResponse` - при ошибке

**Бизнес-логика:**

1. Валидация входных данных
2. Обновление статуса заказа на 2 (отгружен)
3. Указание кладовщика в заказе
4. Обновление фактических количеств в позициях
5. Уведомление администратора и швей об отгрузке

### save_write_off(SaveWriteOffMovementMaterialToWorkshopRequest $request): bool|RedirectResponse

**Описание:** Создает документ на списание материалов.

**Параметры:**

- `$request` - данные для списания

**Возвращает:**

- `bool` - `true` при успехе
- `RedirectResponse` - при ошибке

**Бизнес-логика:**

1. Создание заказа с type_movement = 6 (списание)
2. Установка статуса 3 (завершен)
3. Автоматическое одобрение is_approved = 1
4. Заполнение даты завершения
5. Создание позиций с указанными количествами

### getCountNotShippedMovements(): int

**Описание:** Получает количество не отгруженных запросов на материалы.

**Возвращает:** Количество заказов со статусом 0

### getCountNotReceivedMovements(): int

**Описание:** Получает количество отгруженных, но не полученных запросов.

**Возвращает:** Количество заказов со статусом 2

## Используемые модели и репозитории

- **Order** - основные заказы системы:
    - `type_movement = 2` - запрос материалов в цех
    - `type_movement = 6` - списание материалов
    - `status = 0` - новый запрос
    - `status = 2` - отгружен
    - `status = 3` - завершен
- **MovementMaterial** - позиции перемещения материалов:
    - `order_id` - ссылка на заказ
    - `material_id` - материал
    - `ordered_quantity` - заказанное количество
    - `quantity` - фактическое количество

## Интеграция с другими сервисами

- **TgService:** Отправка уведомлений в Telegram
- **UserService:** Получение списков работающих сотрудников:
    - `getListStorekeepersWorkingToday()` - кладовщики
    - `getListSeamstressesWorkingToday()` - швеи

## Обработка ошибок и исключения

1. **Валидация запросов:** Используются Form Request классы
2. **Транзакции:** Все операции обернуты в DB::beginTransaction()
3. **Rollback при ошибках:** При любом исключении происходит откат транзакции
4. **Возврат false:** При ошибке возвращает `false` для программной обработки

## Бизнес-правила и алгоритмы

### Процесс запроса материалов:

1. **Швея/закройщик создает запрос:**
    - Система определяет роль пользователя
    - Создается заказ с соответствующим полем (seamstress_id/cutter_id)
    - Отправляются уведомления кладовщикам

2. **Кладовщик обрабатывает запрос:**
    - Вносит фактические количества
    - Статус меняется на "отгружен"
    - Отправляются уведомления швеям

3. **Учет списаний:**
    - Отдельный тип перемещения (type_movement = 6)
    - Автоматически одобряется и завершается
    - Не требует уведомлений

### Типы перемещений:

- `type_movement = 2` - Запрос материалов со склада в цех
- `type_movement = 6` - Списание материалов

### Статусы заказов:

- `0` - Новый запрос (не отгружен)
- `1` - В обработке (не используется в текущей логике)
- `2` - Отгружен со склада
- `3` - Завершен

## Особенности реализации

1. **Ролевая модель:** Автоматическое определение поля в зависимости от роли
   пользователя
2. **Телеграм интеграция:** Полноценная система уведомлений всех
   заинтересованных сторон
3. **Атомарность:** Все операции выполняются в транзакциях
4. **Гибкая валидация:** Разные Form Request для разных операций
5. **Списание материалов:** Отдельный упрощенный процесс без уведомлений

## Потенциальные проблемы

1. **Пользовательский ввод:** Нет проверки на отрицательные количества
2. **Concurrent modifications:** Возможны проблемы при одновременном
   редактировании
3. **Нет частичной отгрузки:** Нельзя отгрузить часть заказа
4. **Магические числа:** Статусы и типы захардкожены

## Рекомендации по улучшению

1. Добавить валидацию на отрицательные значения
2. Реализовать частичную отгрузку материалов
3. Добавить историю изменений заказов
4. Вынести константы статусов в enum или класс
5. Добавить проверку доступности материалов на складе
6. Реализовать механизм приоритетов для запросов

## Дата последнего изменения

2025-12-05
