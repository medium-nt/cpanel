# MovementMaterialFromSupplierService

## Назначение сервиса и его основная ответственность

Сервис `MovementMaterialFromSupplierService` управляет процессом поступления
материалов от поставщиков на склад. Основные задачи:

- Создание документов о поступлении материалов
- Обновление цен поступивших материалов
- Фиксация ответственных за приемку
- Логирование операций поступления

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Form Requests:**
    - `StoreMovementMaterialFromSupplierRequest` - валидация создания
      поступления
    - `UpdateMovementMaterialFromSupplierRequest` - валидация обновления цен
- **Models:**
    - `MovementMaterial` - перемещение материалов
    - `Order` - заказы системы
- **Laravel Facades:**
    - `DB` - для транзакций
    - `Log` - для логирования операций

## Публичные методы

### store(StoreMovementMaterialFromSupplierRequest $request): bool|RedirectResponse

**Описание:** Создает документ о поступлении материалов от поставщика.

**Параметры запроса:**

- `material_id[]` - массив ID материалов
- `quantity[]` - массив количеств
- `supplier_id` - ID поставщика
- `comment` - комментарий к поступлению

**Возвращает:**

- `bool` - `true` при успешном создании
- `RedirectResponse` - при ошибке валидации

**Бизнес-логика:**

1. **Валидация:**
    - Проверка наличия материалов и количеств
    - Возврат с ошибкой при некорректных данных

2. **Создание документа поступления:**
    - Создание заказа с параметрами:
        - `supplier_id` - поставщик
        - `storekeeper_id` - ответственный кладовщик
        - `type_movement = 1` - тип "приход от поставщика"
        - `status = 0` - новый документ
        - `completed_at` - текущая дата

3. **Создание позиций материалов:**
    - Для каждого материала создается запись в MovementMaterial
    - Указывается количество

4. **Логирование операции:**
    - Формируется список поступивших материалов
    - Записывается в лог канал 'erp'

**Пример логируемого сообщения:**

```
Кладовщик [Имя] добавил поступление материала на склад от поставщика [Название]:
• Материал1 10 кг
• Материал2 5 шт
```

### update(UpdateMovementMaterialFromSupplierRequest $request, Order $order): bool|RedirectResponse

**Описание:** Обновляет цены и подтверждает поступление материалов.

**Параметры:**

- `$request` - данные с ценами:
    - `id[]` - ID позиций материалов
    - `price[]` - цены материалов
- `$order` - заказ для обновления

**Возвращает:**

- `bool` - `true` при успешном обновлении
- `RedirectResponse` - при ошибке валидации

**Бизнес-логика:**

1. **Валидация данных:**
    - Проверка наличия ID и цен
    - Возврат с ошибкой при некорректных данных

2. **Обновление статуса:**
    - Статус заказа меняется на 3 (завершен)

3. **Обновление цен:**
    - Для каждой позиции обновляется поле `price`
    - Формируется подробный список с ценами

4. **Логирование одобрения:**
    - Записывается информация о том, кто одобрил
    - Включается список материалов с указанием цен

**Пример логируемого сообщения:**

```
Админ [Имя] одобрил поступление материала на склад от поставщика [Название]:
• Материал1 10 кг цена: 150.00
• Материал2 5 шт цена: 75.50
```

## Используемые модели и репозитории

- **Order:** Заказы системы
    - `type_movement = 1` - приход от поставщика
    - `status = 0` - новый документ
    - `status = 3` - завершенный
    - `supplier_id` - поставщик
    - `storekeeper_id` - кладовщик

- **MovementMaterial:** Детали перемещения
    - `order_id` - ссылка на заказ
    - `material_id` - материал
    - `quantity` - количество
    - `price` - цена (обновляется в методе update)

## Интеграция с другими сервисами

Сервис является самодостаточным и не вызывает другие сервисы напрямую.
Используется другими компонентами системы для управления поступлением
материалов.

## Обработка ошибок и исключения

1. **Валидация:** Через Form Request классы
2. **Транзакционная целостность:** Все операции обернуты в DB::transaction
3. **Rollback при ошибках:** Откат транзакции при любом исключении
4. **Возврат статуса:** `false` при ошибке для программной обработки
5. **Логирование:** Операции логируются в канал 'erp'

## Бизнес-правила и алгоритмы

### Процесс поступления материалов:

1. **Приемка:**
    - Кладовщик создает документ поступления
    - Указывает поставщика, материалы и количества
    - Документ получает статус "новый"

2. **Обработка:**
    - Администратор проверяет поступление
    - Вносит цены материалов
    - Подтверждает поступление
    - Статус меняется на "завершен"

### Правила:

- Только кладовщик может создавать поступления
- Только администратор может утверждать и указывать цены
- Все операции должны быть выполнены в транзакции

## Особенности реализации

1. **Разделение ответственности:** Создание и обновление в разных методах
2. **Детальное логирование:** Включает все необходимые данные для аудита
3. **Ролевая модель:** Разные роли для разных операций
4. **Атомарность:** Гарантия целостности данных

## Потенциальные проблемы

1. **Отсутствие уведомлений:** Нет сообщений в Telegram о поступлениях
2. **Нет проверки цен:** Отрицательные или некорректные цены не проверяются
3. **Жесткие статусы:** Типы и статусы захардкожены
4. **Отсутствие контроля:** Нет проверки на дубликаты поступлений

## Рекомендации по улучшению

1. **Уведомления:** Добавить сообщения о поступлениях в Telegram
2. **Валидация цен:** Проверка на отрицательные значения и нули
3. **Константы:** Вынести типы и статусы в enum
4. **Аудит:** Добавить историю изменений цен
5. **Интеграция:** Связь с финансовым учетом для отражения затрат

## Пример использования

```php
// Создание поступления
$success = MovementMaterialFromSupplierService::store($request);

// Обновление цен и утверждение
$success = MovementMaterialFromSupplierService::update($request, $order);
```

## Дата последнего изменения

2025-12-05
