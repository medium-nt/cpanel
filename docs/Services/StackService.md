# StackService

## Назначение сервиса и его основная ответственность

Сервис `StackService` управляет стеком заказов для швей (seamstress). Отвечает
за отслеживание текущего количества заказов в работе и максимального количества
заказов, которое было у швеи. Сервис реализует паттерн счетчика для управления
рабочей нагрузкой сотрудников.

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- `App\Models\Stack` - Eloquent модель для хранения данных о стеке заказов
- `MarketplaceOrderItemService` - сервис для получения максимального количества
  заказов (используется в одном методе)

## Публичные методы

### incrementStackAndMaxStack($seamstressId): void

**Описание:** Увеличивает текущий счетчик заказов (`stack`) и максимальный
счетчик (`max`) для указанной швеи.

**Параметры:**

- `$seamstressId` (mixed) - ID швеи

**Бизнес-логика:**

1. Находит запись в таблице stacks по ID швеи
2. Увеличивает оба счетчика на 1
3. Сохраняет изменения

**Примечание:** Метод предполагает, что запись для швеи уже существует. Если
запись не найдена, произойдет ошибка.

### reduceStack($seamstressId): void

**Описание:** Уменьшает текущий счетчик заказов (`stack`) для указанной швеи.

**Параметры:**

- `$seamstressId` (mixed) - ID швеи

**Бизнес-логика:**

1. Находит запись в таблице stacks по ID швеи
2. Уменьшает счетчик `stack` на 1
3. Сохраняет изменения
4. **Дополнительная логика при обнулении стека:**
    - Если `stack` становится равным 0
    - Получает максимальное значение стека из базы
    - Сравнивает с максимально допустимым количеством заказов для роли
    - Если максимальный стек достиг или превышен лимит, сбрасывает `max` в 0

## Приватные методы

### getMaxStackByUser($seamstressId)

**Описание:** Получает или создает запись о стеке для указанной швеи.

**Параметры:**

- `$seamstressId` (mixed) - ID швеи

**Возвращает:** `Stack` - модель с данными о стеке

**Логика:** Использует `firstOrCreate` для атомарной операции получения или
создания записи с начальными значениями (0).

### resetMaxStackToZero($seamstressId): void

**Описание:** Сбрасывает максимальный счетчик заказов в 0 для указанной швеи.

**Параметры:**

- `$seamstressId` (mixed) - ID швеи

**Логика:** Находит запись и устанавливает поле `max` в 0.

## Используемые модели и репозитории

- `Stack` - основная модель сервиса, хранит:
    - `seamstress_id` - ID швеи
    - `stack` - текущее количество заказов в работе
    - `max` - максимальное количество заказов, которое было у швеи

## Интеграция с другими сервисами

- **MarketplaceOrderItemService:** Используется в методе `reduceStack` для
  получения максимально допустимого количества заказов через статический метод
  `getMaxQuantityOrdersToUserRole()`

## Обработка ошибок и исключения

Сервис не содержит явной обработки ошибок. Возможные проблемы:

1. В методе `incrementStackAndMaxStack` и `reduceStack` - если запись для швеи
   не существует, возникнет ошибка при попытке вызова методов на null
2. Отсутствует валидация входных параметров
3. Нет проверки на отрицательные значения при уменьшении стека

## Бизнес-правила и алгоритмы

### Алгоритм управления стеком заказов:

1. **При получении нового заказа:**
    - Вызов `incrementStackAndMaxStack()`
    - Оба счетчика увеличиваются на 1

2. **При завершении заказа:**
    - Вызов `reduceStack()`
    - Уменьшается только текущий счетчик
    - Если стек опустел (стек = 0):
        * Проверяется, был ли достигнут лимит заказов
        * Если да - максимальный счетчик сбрасывается в 0

### Сценарий использования:

- Швея взяла заказ → stack: 1, max: 1
- Швея взяла еще заказ → stack: 2, max: 2
- Швея завершила заказ → stack: 1, max: 2
- Швея завершила второй заказ → stack: 0, max: 0 (если достигнут лимит)

## Особенности реализации

1. **Статический класс:** Все методы статические, не требуется создание
   экземпляра
2. **Паттерн Counter:** Реализует паттерн счетчика для управления рабочей
   нагрузкой
3. **Атомарность:** Использует `firstOrCreate` для безопасного создания записей
4. **Бизнес-логика в домене:** Встроена логика лимитирования заказов для
   сотрудников
5. **Отсутствие транзакций:** Операции не обернуты в транзакции, что может
   привести к проблемам при конкурентном доступе

## Рекомендации по улучшению

1. Добавить валидацию входных параметров
2. Обернуть операции в транзакции для обеспечения консистентности
3. Добавить обработку случая, когда запись не найдена
4. Рассмотреть использование атомарных операций инкремента/декремента на уровне
   БД
5. Добавить логирование операций для аудита

## Дата последнего изменения

2025-12-05
