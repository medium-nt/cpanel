# UserService

## Назначение сервиса и его основная ответственность

Сервис `UserService` управляет пользователями системы и их рабочими процессами.
Основные задачи:

- Управление профилями пользователей
- Контроль рабочего времени и смен
- Расчет и начисление штрафов
- Управление ставками и мотивацией
- Отправка уведомлений сотрудникам
- Проверка barcode для идентификации

## Зависимости и внедрения (constructor)

Сервис не имеет конструктора и зависимостей. Используемые импорты:

- **Models:**
    - `Material` - материалы
    - `Motivation` - мотивация сотрудников
    - `Rate` - ставки оплаты
    - `Schedule` - график работы
    - `Setting` - настройки системы
    - `Transaction` - финансовые транзакции
    - `User` - пользователи
- **Laravel:**
    - `Carbon` - работа с датами
    - `Request` - HTTP запросы
    - `Collection` - коллекции
    - `Log` - логирование
    - `Storage` - файловое хранилище
- **Services:**
    - `TgService` - отправка сообщений

## Публичные методы

### Управление пользователями

#### saved(Request $request, User $user): bool

**Описание:** Сохраняет изменения в профиле пользователя.

**Поля для обновления:**

- `name` - имя
- `email` - email
- `phone` - телефон
- `salary_rate` - ставка зарплаты
- `password` - пароль (если указан)
- `avatar` - изображение аватара
- `orders_priority` - приоритет заказов (`all`, `fbo`, `fbo_200`)
- `is_cutter` - является ли закройщиком
- `start_work_shift` - начало смены
- `duration_work_shift` - длительность смены
- `max_late_minutes` - максимальное опоздание
- `materials` - доступные материалы
- `is_show_finance` - показывать финансы

**Особенности:**

- Пароль шифруется через bcrypt
- Аватар сохраняется с именем файла = ID пользователя
- Только админ может изменять доступные материалы

#### getUserByBarcode($barcode): ?User

**Описание:** Находит пользователя по штрихкоду формата "user-ID".

**Возвращает:** `User` или `null`

### Управление рабочими сменами

#### checkWorkShiftClosure(User $user): void

**Описание:** Проверяет подозрительное закрытие смены (сразу после другого
пользователя).

**Логика:**

- Ищет последнего пользователя, закрывшего смену
- Проверяет разницу во времени (< 2 минут)
- При подозрении логирует и уведомляет админа

#### checkUnclosedWorkShifts(): void

**Описание:** Проверяет незакрытые смены и начисляет штрафы.

**Процесс:**

1. Находит пользователей с открытыми сменами
2. Создает транзакцию штрафа из настроек
3. Логирует операцию
4. Закрывает смену пользователю

#### checkLateStartWorkShift(User $user): void

**Описание:** Проверяет опоздание на смену и начисляет штраф.

**Логика:**

- Рассчитывает максимальное время начала смены
- Если текущее время больше - начисляет штраф

#### clearTimeForClosedWorkShifts(): void

**Описание:** Сбрасывает время закрытия смен для всех закрытых смен.

#### isSecondShiftOpeningToday(User $user): bool

**Описание:** Проверяет, открывал ли пользователь смену сегодня.

### Вспомогательные методы

#### translateRoleName($role): string

**Описание:** Переводит системное название роли на русский.

**Соответствия:**

- `admin` → `Руководитель`
- `storekeeper` → `Кладовщик`
- `seamstress` → `Швея`
- `cutter` → `Закройщик`
- `otk` → `Сотрудник ОТК`

### Работа с графиком

#### getListSeamstressesWorkingToday(): Collection

**Описание:** Возвращает Telegram ID швей, работающих сегодня.

#### getListStorekeepersWorkingToday(): Collection

**Описание:** Возвращает Telegram ID кладовщиков, работающих сегодня.

#### sendMessageForWorkingTodayEmployees(): void

**Описание:** Отправляет сообщение всем работающим сегодня сотрудникам со
списком коллег.

**Пример сообщения:**

```
Сегодня работают:
• Иван Иванов (Швея)
• Петр Петров (Закройщик)
```

### Финансы и ставки

#### getMotivationByUserId(mixed $id): Collection

**Описание:** Получает мотивационные схемы пользователя.

#### getRateByUserId(mixed $id): Collection

**Описание:** Получает ставки пользователя по материалам.

**Возвращает:** Материалы типа 1 (ткани) со ставками пользователя.

#### updateUserMaterialRates(User $user, Request $request): void

**Описание:** Обновляет ставки пользователя по материалам.

**Обновляемые поля:**

- `rate` - базовая ставка
- `not_cutter_rate` - ставка при работе не закройщиком
- `cutter_rate` - ставка закройщика

## Приватные методы

### getListEmployeesWorkingTodayByRole($roleId): Collection

**Описание:** Базовый метод получения списка TG ID по роли.

**Логика:**

- Ищет записи в Schedule на сегодня
- Фильтрует по role_id
- Возвращает только пользователей с TG ID

## Используемые модели и репозитории

- **User:**
    - `shift_is_open` - флаг открытой смены
    - `closed_work_shift` - время закрытия смены
    - `start_work_shift` - начало смены
    - `max_late_minutes` - допустимое опоздание
    - `materials` - доступные материалы
    - `orders_priority` - приоритет заказов

- **Schedule:**
    - `date` - дата работы
    - `shift_opened_time` - время открытия смены
    - `shift_closed_time` - время закрытия смены

- **Transaction:**
    - Создается для штрафов
    - `transaction_type = 'in'` - начисление
    - `status = 1` - подтвержден

- **Setting:**
    - `unclosed_shift_penalty` - штраф за незакрытую смену
    - `late_opened_shift_penalty` - штраф за опоздание

## Интеграция с другими сервисами

- **TgService:** Отправка уведомлений сотрудникам
- Используется другими сервисами для получения списков работающих сотрудников

## Обработка ошибок и исключения

1. **Валидация:** Через правила в методе saved()
2. **Логирование:** Все операции логируются в соответствующие каналы
3. **Null safety:** Проверки на null при работе с моделями

## Бизнес-правила и алгоритмы

### Управление сменами:

1. **Открытие смены:** Проверка графика и времени
2. **Закрытие смены:**
    - Проверка на подозрительное быстрое закрытие
    - Фиксация времени закрытия
3. **Ежедневная проверка:**
    - Незакрытые смены → Штраф
    - Опоздания → Штраф

### Штрафы:

- **За незакрытую смену:** Берется из настроек, начисляется ночью
- **За опоздание:** Рассчитывается индивидуально (время + допуск)
- **Логируются:** В канал 'salary'

### Управление ставками:

- **Типы материалов:** Только ткани (type_id = 1)
- **Два типа ставок:** Общая и для закройщика
- **Атомарное обновление:** updateOrCreate

## Особенности реализации

1. **Ролевая модель:** Разная логика для разных ролей
2. **Автоматические штрафы:** Система автоматически отслеживает нарушения
3. **Telegram интеграция:** Полноценная система уведомлений
4. **Flexible настройки:** Большинство параметров настраивается
5. **Безопасность:** Шифрование паролей, валидация данных

## Потенциальные проблемы

1. **Жесткое время:** 2 минуты для подозрительного закрытия захардкожены
2. **Нет timezone:** Все операции в серверном времени
3. **Магические числа:** Статусы и роли захардкожены
4. **File handling:** Нет обработки ошибок при сохранении аватара

## Рекомендации по улучшению

1. **Конфигурация:** Вынести время и лимиты в настройки
2. **Timezone:** Добавить работу с часовыми поясами
3. **Events:** Добавить события при изменениях пользователей
4. **Audit trail:** Расширить логирование операций
5. **Validation:** Усилить валидацию входных данных

## Пример использования

```php
// Сохранение пользователя
$success = UserService::saved($request, $user);

// Поиск по штрихкоду
$user = UserService::getUserByBarcode('user-123');

// Проверка смены
UserService::checkWorkShiftClosure($user);

// Обновление ставок
$service = new UserService();
$service->updateUserMaterialRates($user, $request);
```

## Дата последнего изменения

2025-12-05
