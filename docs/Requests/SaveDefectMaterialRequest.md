# SaveDefectMaterialRequest

## Назначение класса валидации

Класс `SaveDefectMaterialRequest` предназначен для валидации запросов на
создание записей о бракованных материалах или остатках. Этот класс используется
для фиксации материалов, которые были признаны браком или остались
неиспользованными в процессе производства.

## Правила авторизации (метод authorize)

```php
public function authorize(): bool
{
    return true;
}
```

- Все авторизованные пользователи имеют право выполнять данный запрос
- Дополнительные проверки авторизации не требуются

## Правила валидации (метод rules)

```php
public function rules(): array
{
    return [
        'comment' => 'nullable|string|min:2|max:255',
        'material_id.*.required' => 'Материал обязателен.',
        'material_id.*.exists' => 'Материал не найден.',
        'quantity.*.required' => 'Количество обязательно.',
        'quantity.*.min' => 'Количество должно быть больше или равно нулю.',
        'type_movement_id' => 'required|in:4,7',
    ];
}
```

### Поля валидации:

- **`comment`** - Комментарий к операции
    - `nullable` - Может быть пустым (null)
    - `string` - Должно быть строкой
    - `min:2` - Минимальная длина - 2 символа
    - `max:255` - Максимальная длина - 255 символов

- **`material_id.*`** - Массив идентификаторов материалов
    - Правило определено некорректно - содержит сообщение об ошибке вместо
      правил валидации
    - Корректные правила должны быть: `required|exists:movement_materials,id`

- **`quantity.*`** - Массив количеств материалов
    - Правило определено некорректно - содержит сообщение об ошибке вместо
      правил валидации
    - Корректные правила должны быть: `required|numeric|min:0`

- **`type_movement_id`** - Тип перемещения
    - `required` - Поле обязательно для заполнения
    - `in:4,7` - Значение должно быть 4 или 7 (соответствует типам "брак" или "
      остаток")

## Кастомные сообщения об ошибках (метод messages)

```php
public function messages(): array
{
    return [
        'comment.min' => 'Комментарий должен содержать минимум :min символов.',
        'comment.max' => 'Комментарий должен содержать максимум :max символов.',
        'material_id.*.required' => 'Материал обязателен.',
        'material_id.*.exists' => 'Материал не найден.',
        'quantity.*.required' => 'Количество обязательно.',
        'quantity.*.min' => 'Количество должно быть больше нуля.',
        'type_movement_id.required' => 'Тип перемещения не верен. Выберете "брак" или "остаток"',
        'type_movement_id.in' => 'Тип перемещения не верен. Выберете "брак" или "остаток"',
    ];
}
```

## Кастомные атрибуты (метод attributes)

В данном классе метод `attributes` не определен.

## Особенности валидации

1. **Типы перемещений** - Поддерживаются только два типа операций:
    - **ID 4** - Брак (defect)
    - **ID 7** - Остатки (remnants)

2. **Некорректная структура правил** - В методе `rules()` правила определены в
   неверном формате:
    - Вместо правил валидации указаны сообщения об ошибках
    - Правильный формат для `material_id.*`:
      `'material_id.*' => 'required|exists:movement_materials,id'`

3. **Массивная валидация** - Класс ожидает получение массивов данных для
   массового учета брака/остатков

4. **Проверка существования** - Каждый идентификатор материала проверяется на
   существование (хотя таблица не указана)

5. **Допустимость нулевого количества** - Комментарий в правилах говорит о том,
   что количество должно быть больше или равно нулю

6. **Несоответствие сообщений** - В методе `messages()` указано сообщение "
   Количество должно быть больше нуля", что противоречит комментарию в правилах

## Используемые в контроллерах

Данный Form Request используется в контроллере, ответственном за учет брака и
остатков:

```php
// Пример использования в контроллере
public function save(SaveDefectMaterialRequest $request)
{
    $validated = $request->validated();

    if ($validated['type_movement_id'] == 4) {
        // Логика обработки брака
    } elseif ($validated['type_movement_id'] == 7) {
        // Логика обработки остатков
    }
}
```

Пример валидных данных для брака:

```json
{
    "comment": "Брак при кройке - дефект материала",
    "material_id": ["456", "789"],
    "quantity": ["5", "2"],
    "type_movement_id": "4"
}
```

Пример валидных данных для остатков:

```json
{
    "comment": "Остатки после выполнения заказа",
    "material_id": ["456"],
    "quantity": ["3"],
    "type_movement_id": "7"
}
```

## Заметки о реализации

В коде класса присутствуют ошибки, которые рекомендуется исправить:

```php
// Правильная структура правил
public function rules(): array
{
    return [
        'comment' => 'nullable|string|min:2|max:255',
        'material_id.*' => 'required|exists:movement_materials,id',
        'quantity.*' => 'required|numeric|min:0',
        'type_movement_id' => 'required|in:4,7',
    ];
}

// Исправленные сообщения
public function messages(): array
{
    return [
        'comment.min' => 'Комментарий должен содержать минимум :min символов.',
        'comment.max' => 'Комментарий должен содержать максимум :max символов.',
        'material_id.*.required' => 'Материал обязателен.',
        'material_id.*.exists' => 'Материал не найден.',
        'quantity.*.required' => 'Количество обязательно.',
        'quantity.*.min' => 'Количество должно быть больше или равно нулю.',
        'type_movement_id.required' => 'Тип перемещения обязателен',
        'type_movement_id.in' => 'Выберите корректный тип перемещения: брак (4) или остаток (7)',
    ];
}
```
