# HomeController

## Общее назначение

`HomeController` - основной контроллер для отображения дашборда приложения.
Отвечает за сбор и отображение сводной информации о текущем состоянии системы,
включая график работы сотрудников, статистику заказов, финансовые показатели и
другие важные метрики.

**Путь:** `app/Http/Controllers/HomeController.php`

## Зависимости

### Модели

- `App\Models\Transaction` - модель финансовых транзакций
- `App\Models\User` - модель пользователей

### Сервисы

- `App\Services\MarketplaceOrderItemService` - сервис для работы с элементами
  заказов маркетплейсов
- `App\Services\MarketplaceOrderService` - сервис для работы с заказами
  маркетплейсов
- `App\Services\MovementMaterialToWorkshopService` - сервис для управления
  перемещениями материалов
- `App\Services\ScheduleService` - сервис для работы с расписанием
- `App\Services\TransactionService` - сервис для работы с финансовыми
  транзакциями

### Middleware

- `auth` - требует аутентификации пользователя для доступа ко всем методам
  контроллера

## Методы

### `__construct()`

**Описание:** Конструктор контроллера, применяющий middleware для
аутентификации.

```php
public function __construct()
{
    $this->middleware('auth');
}
```

- **Middleware:** `auth` - все методы требуют аутентификации
- **Назначение:** Обеспечивает доступ к дашборду только авторизованным
  пользователям

---

### `index(Request $request)`

**Описание:** Основной метод для отображения дашборда с информацией о состоянии
системы.

**Параметры:**

- `$request` (`Illuminate\Http\Request`) - HTTP запрос с опциональными
  параметрами

**Возвращает:** `Illuminate\View\View` - отображение дашборда с набором данных

**Маршрут:** `GET /home` (routes/web.php:38)

**Логика работы:**

1. **Получение параметров запроса:**
    - `employee_id` - ID сотрудника (по умолчанию ID текущего пользователя)
    - `days_ago` - количество дней для расчёта рейтинга (0-28, по умолчанию 0)

2. **Валидация параметров:**
    - Проверяет, что `days_ago` находится в диапазоне 0-28
    - При некорректных значениях устанавливает значение по умолчанию (0)

3. **Сбор данных для дашборда:**

   **Расписание и события:**
    - `events` - расписание сотрудника через
      `ScheduleService::getScheduleByUserId()`

   **Статистика заказов маркетплейсов:**
    - `cutMarketplaceOrderItem` - количество выкроенных заказов
    - `newMarketplaceOrderItem` - количество новых заказов
    - `marketplaceOrderItemInWork` - заказов в работе
    - `marketplaceOrderItemInCutting` - заказов на раскрое
    - `urgentMarketplaceOrderItem` - срочных заказов

   **Перемещения материалов:**
    - `notShippedMovements` - количество не отгруженных перемещений
    - `notReceivedMovements` - количество непринятых перемещений

   **Пользователи:**
    - `employees` - пагинированный список сотрудников (исключая тестовых)
    - `currentUserId` - ID текущего пользователя

   **Рейтинги и статистика:**
    - `dates` - даты для расчёта рейтинга по размерам
    - `seamstresses` - рейтинг швей по размерам в JSON
    - `days_ago` - используемое количество дней
    - `rating` - общий рейтинг

   **Финансовые показатели:**
    - `seamstressesCurrentSalary` - текущий баланс зарплаты швей
    - `seamstressesCurrentBonus` - текущий баланс бонусов швей
    - `seamstressesCurrentHoldBonus` - удержанные бонусы швей

   **Заказы на самовывоз:**
    - `pickupOrders` - количество заказов на самовывоз

   **Транзакции:**
    - `transactions` - пагинированный список входящих транзакций со статусом 1

4. **Особенности реализации:**
    - Использует пагинацию для списков сотрудников и транзакций
    - Сохраняет параметры запроса в пагинационных ссылках через
      `withQueryString()`
    - Кодирует некоторые данные в JSON для использования в JavaScript
    - Исключает тестовых пользователей из списка сотрудников

## Используемые Gates и политики

Контроллер не использует явные проверки через Gates, но применяет middleware
`auth`, что требует аутентификации пользователя.

## Особенности архитектуры

1. **Тонкий контроллер:** Основная бизнес-логика вынесена в сервисы
2. **Инъекция зависимостей:** Зависимости от сервисов реализованы через
   статические вызовы
3. **Соблюдение Single Responsibility:** Контроллер отвечает только за
   отображение дашборда
4. **Использование пагинации:** Для больших объёмов данных применяется пагинация

## Потенциальные точки улучшения

1. Можно добавить кэширование для дорогостоящих запросов (рейтинги, статистика)
2. Вынести сбор данных в отдельный сервис для улучшения тестируемости
3. Добавить валидацию параметров запроса через Form Request
4. Добавить Type Hints для возвращаемых значений методов сервисов

## Связанные маршруты

- `GET /home` - отображение дашборда (основной маршрут контроллера)
- Требуется аутентификация через middleware `auth`

## Примечания

- Контроллер является центральным элементом системы, предоставляя сводную
  информацию для принятия решений
- Данные обновляются в реальном времени при каждом обращении к дашборду
- Используется как стартовая страница после авторизации пользователя в системе
