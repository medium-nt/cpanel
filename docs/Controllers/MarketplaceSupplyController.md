# MarketplaceSupplyController

## Общее назначение контроллера

Контроллер управляет поставками на маркетплейсы. Обеспечивает полный жизненный
цикл поставки: от создания до сдачи в маркетплейс, включая управление заказами в
поставке, обновление статусов, генерацию документации и штрихкодов.

## Зависимости и внедрения

- `App\Models\MarketplaceSupply` - Eloquent модель поставки
- `App\Services\MarketplaceApiService` - Сервис для работы с API маркетплейсов
- `App\Services\MarketplaceOrderService` - Сервис для работы с заказами
- `App\Services\MarketplaceSupplyService` - Сервис для работы с поставками
- `App\Services\TgService` - Сервис для отправки уведомлений в Telegram
- `Illuminate\Http\Request` - Стандартный Request класс Laravel
- `Illuminate\Support\Facades\Log` - Фасад для логирования
- `Illuminate\Support\Facades\Storage` - Фасад для работы с файлами

## Список всех методов с описанием

### `index(Request $request)`

- **Описание:** Отображает список поставок с фильтрацией
- **Параметры:**
    - `$request` (Request) - HTTP запрос с фильтрами:
        - `status` (int) - Статус поставки (3 - завершенные, остальные -
          активные)
        - `marketplace_id` (int) - ID маркетплейса
        - `search` (string) - Поиск по номеру поставки
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_supply.index`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Использует `MarketplaceSupply::query()`
    - Фильтрация по статусу, маркетплейсу, номеру поставки
    - Сортировка по `created_at` DESC
    - Пагинация по 10 записей
- **Особенности бизнес-логики:** Статус 3 (завершенные) обрабатывается отдельно

### `show(MarketplaceSupply $marketplaceSupply)`

- **Описание:** Показывает детальную информацию о поставке
- **Параметры:**
    - `$marketplaceSupply` (MarketplaceSupply) - Модель поставки (route model
      binding)
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_supply.show`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Получает заказы поставки через связку `marketplace_orders()`
    - Проверяет наличие отгруженных заказов
- **Особенности бизнес-логики:**
    - Отображает название маркетплейса
    - Показывает информацию о статусах заказов

### `create(string $marketplace_id)`

- **Описание:** Создает новую поставку для указанного маркетплейса
- **Параметры:**
    - `$marketplace_id` (string) - ID маркетплейса
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
  поставок
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Создает запись в `MarketplaceSupply`
    - Проверяет наличие открытых поставок для Ozon (marketplace_id = 1)
- **Особенности бизнес-логики:**
    - Для Ozon запрещено создавать более одной открытой поставки
    - Логирует создание поставки в 'erp' канал

### `destroy(MarketplaceSupply $marketplace_supply)`

- **Описание:** Удаляет поставку
- **Параметры:**
    - `$marketplace_supply` (MarketplaceSupply) - Модель поставки
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:** Удаляет поставку если проверка прошла
- **Особенности бизнес-логики:**
    - Защищает от удаления поставки с заказами
    - Проверяет наличие связанных заказов перед удалением

### `complete(MarketplaceSupply $marketplace_supply)`

- **Описание:** Формирует и закрывает поставку для отгрузки
- **Параметры:**
    - `$marketplace_supply` (MarketplaceSupply) - Модель поставки
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Обновляет статус поставки на 4
    - Обновляет статусы всех заказов на 3
    - Устанавливает `completed_at`
- **Особенности бизнес-логики:**
    - Обновляет статусы заказов через API перед формированием
    - Проверяет наличие заказов с неподходящим статусом
    - Выполняет сборку поставки через API:
        - Ozon: `MarketplaceApiService::ozonSupply()`
        - WB: `MarketplaceApiService::wbSupply()`
    - Проверяет наличие видео, отправляет уведомление в Telegram если нет

### `done(MarketplaceSupply $marketplace_supply)`

- **Описание:** Отмечает поставку как сданную в маркетплейс
- **Параметры:**
    - `$marketplace_supply` (MarketplaceSupply) - Модель поставки
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Обновляет статус на 3
    - Устанавливает `completed_at`
- **Особенности бизнес-логики:**
    - Логирует сдачу поставки
    - Финальный статус в системе

### `getDocs(MarketplaceSupply $marketplace_supply)`

- **Описание:** Получает документы для поставки
- **Параметры:**
    - `$marketplace_supply` (MarketplaceSupply) - Модель поставки
- **Возвращает:** `Response` - Файлы документации или редирект с ошибкой
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Проверяет статус документов
- **Работа с БД:** Не изменяет данные
- **Особенности бизнес-логики:**
    - Проверяет сформированы ли документы через API
    - Только для Ozon поставок

### `getBarcode(MarketplaceSupply $marketplace_supply)`

- **Описание:** Получает штрихкоды для поставки
- **Параметры:**
    - `$marketplace_supply` (MarketplaceSupply) - Модель поставки
- **Возвращает:** `Response` - Файл штрихкодов или редирект с ошибкой
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Проверяет корректность маркетплейса
- **Работа с БД:** Не изменяет данные
- **Особенности бизнес-логики:**
    - Использует разные методы для разных маркетплейсов:
        - Ozon: `MarketplaceApiService::getBarcodeSupplyOzon()`
        - WB: `MarketplaceApiService::getBarcodeSupplyWB()`

### `updateStatusOrders(MarketplaceSupply $marketplace_supply)`

- **Описание:** Обновляет статусы заказов в поставке
- **Параметры:**
    - `$marketplace_supply` (MarketplaceSupply) - Модель поставки
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на страницу
  поставки
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Проверяет корректность маркетплейса
- **Работа с БД:** Обновление выполняется через API
- **Особенности бизнес-логики:**
    - Вызывает API для обновления статусов:
        - Ozon: `MarketplaceApiService::updateStatusOrderBySupplyOzon()`
        - WB: `MarketplaceApiService::updateStatusOrderBySupplyWB()`
    - Логирует обновление

### `delete_video(MarketplaceSupply $marketplace_supply)`

- **Описание:** Удаляет видео файл поставки
- **Параметры:**
    - `$marketplace_supply` (MarketplaceSupply) - Модель поставки
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Возврат на предыдущую
  страницу
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Удаляет запись о видео из БД
    - Удаляет файл из хранилища
- **Особенности бизнес-логики:**
    - Проверяет существование файла перед удалением
    - Логирует удаление видео

### `chunkedUpload(Request $request)`

- **Описание:** Загружает видео файл по частям (chunked upload)
- **Параметры:**
    - `$request` (Request) - HTTP запрос с частями файла
- **Возвращает:** `Response` - JSON ответ о статусе загрузки
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Выполняется в сервисе
- **Работа с БД:** Делегирует `MarketplaceSupplyService::chunkedUpload()`
- **Особенности бизнес-логики:**
    - Поддержка загрузки больших файлов
    - Обработка multipart загрузки

### `close(MarketplaceSupply $marketplace_supply)`

- **Описание:** Вручную закрывает поставку (исключительная ситуация)
- **Параметры:**
    - `$marketplace_supply` (MarketplaceSupply) - Модель поставки
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Обновляет статус поставки на 3
    - Обновляет статусы всех заказов на 3
    - Устанавливает `completed_at`
- **Особенности бизнес-логики:**
    - Ручное закрытие для исключительных случаев
    - Логирует ручное закрытие

## Статусы поставки

- **0** - Открытая/новая
- **4** - Сформирована (передана в отгрузку)
- **3** - Завершена/сдана

## Идентификаторы маркетплейсов

- **1** - Ozon
- **2** - Wildberries

## Общие паттерны и особенности

1. **Интеграция с API:**
    - Активное использование `MarketplaceApiService`
    - Обновление статусов через API маркетплейсов
    - Получение документации и штрихкодов

2. **Валидация и проверки:**
    - Проверка наличия заказов перед действиями
    - Проверка статусов перед формированием
    - Защита от удаления непустых поставок

3. **Уведомления:**
    - Интеграция с Telegram для уведомлений
    - Логирование всех важных действий

4. **Работа с файлами:**
    - Поддержка видео для поставок
    - Chunked upload для больших файлов
    - Генерация и скачивание документации

5. **Журналирование:**
    - Все операции логируются в 'erp' канал
    - Фиксируется кто и когда выполнил действие
