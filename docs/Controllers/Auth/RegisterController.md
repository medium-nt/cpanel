# RegisterController

## Общее назначение

`RegisterController` отвечает за регистрацию новых пользователей в системе. Он
управляет процессом создания аккаунтов, включая валидацию данных, хеширование
паролей и сохранение пользователей в базе данных.

## Путь к файлу

`app/Http/Controllers/Auth/RegisterController.php`

## Наследование и трейты

- **Наследует:** `App\Http\Controllers\Controller`
- **Используемые трейты:**
    - `Illuminate\Foundation\Auth\RegistersUsers` - предоставляет основную
      функциональность для регистрации

## Зависимости

- `App\Models\User` - модель пользователя
- `Illuminate\Support\Facades\Hash` - для хеширования паролей
- `Illuminate\Support\Facades\Validator` - для валидации данных

## Свойства

### $redirectTo

- **Тип:** `string`
- **Значение по умолчанию:** `'/home'`
- **Описание:** URL, куда будет перенаправлен пользователь после успешной
  регистрации

## Конструктор

### __construct()

- **Описание:** Инициализирует контроллер с кастомным middleware
- **Middleware:**
    - Проверяет наличие пользователей с ролью `role_id = 3`
    - Если такие пользователи существуют - перенаправляет на страницу входа
    - Блокирует регистрацию если в системе уже есть пользователи с ролью 3
- **Особенность:** Закомментирован стандартный middleware `guest`, вместо него
  используется кастомная логика

## Методы

### validator(array $data)

- **Тип:** `protected`
- **Описание:** Создает валидатор для данных регистрации
- **Параметры:**
    - `$data` (array) - массив данных из формы регистрации
- **Возвращает:** `\Illuminate\Contracts\Validation\Validator`
- **Правила валидации:**
    - `name` - required, string, max:255
    - `email` - required, string, email, max:255, unique:users
    - `password` - required, string, min:6, confirmed
- **Примечание:** Поле `password_confirmation` автоматически проверяется на
  соответствие полю `password`

### create(array $data)

- **Тип:** `protected`
- **Описание:** Создает нового пользователя после успешной валидации
- **Параметры:**
    - `$data` (array) - валидированные данные из формы
- **Возвращает:** `App\Models\User`
- **Действия:**
    - Создает пользователя в базе данных
    - Хеширует пароль с использованием `Hash::make()`
    - Сохраняет name, email и hashed password
- **Используемый Query Builder:** `User::query()->create([...])`

## Методы из трейта RegistersUsers

Контроллер наследует следующие методы из трейта:

### showRegistrationForm()

- **Описание:** Отображает форму регистрации
- **Route:** `GET /register`
- **Возвращает:** `Illuminate\View\View`
- **View:** `auth.register`

### register(Request $request)

- **Описание:** Обрабатывает отправку формы регистрации
- **Route:** `POST /register`
- **Параметры:**
    - `$request` (Illuminate\Http\Request) - HTTP запрос с данными регистрации
- **Поток выполнения:**
    1. Вызывает метод `validator()` для валидации данных
    2. При успехе вызывает метод `create()` для создания пользователя
    3. Аутентифицирует нового пользователя
    4. Перенаправляет на `$redirectTo`

## Особенности реализации

### Ограничение регистрации

В отличие от стандартной реализации Laravel, этот контроллер включает уникальную
логику ограничения регистрации:

```php
$this->middleware(function ($request, $next) {
    if (User::query()->where('role_id', 3)->count() > 0) {
        return redirect()->route('login');
    }
    return $next($request);
});
```

Эта логика:

1. Проверяет наличие пользователей с `role_id = 3`
2. Если такие пользователи есть - блокирует регистрацию
3. Перенаправляет attempting пользователей на страницу входа
4. Вероятно, роль 3 - это роль администратора или суперпользователя

## Поток выполнения

1. Пользователь переходит на `/register`
2. Middleware проверяет, разрешена ли регистрация
3. Отображается форма регистрации
4. Пользователь заполняет форму и отправляет
5. Система валидирует данные
6. Создается новый пользователь с захешированным паролем
7. Пользователь автоматически аутентифицируется
8. Перенаправление на домашнюю страницу

## Настройки и возможности кастомизации

### Изменение полей регистрации

```php
protected function validator(array $data)
{
    return Validator::make($data, [
        'name' => ['required', 'string', 'max:255'],
        'surname' => ['required', 'string', 'max:255'],
        'email' => ['required', 'string', 'email', 'max:255', 'unique:users'],
        'password' => ['required', 'string', 'min:8', 'confirmed'],
        'phone' => ['required', 'string', 'regex:/^[0-9]{10,15}$/'],
    ]);
}
```

### Добавление дополнительных полей при создании

```php
protected function create(array $data)
{
    return User::query()->create([
        'name' => $data['name'],
        'surname' => $data['surname'],
        'email' => $data['email'],
        'phone' => $data['phone'],
        'password' => Hash::make($data['password']),
        'role_id' => 2, // роль по умолчанию
    ]);
}
```

### Custom redirect после регистрации

```php
protected function redirectTo()
{
    // Логика определения редиректа
    return '/welcome';
}
```

### Отключение автоматического входа

```php
public function register(Request $request)
{
    $this->validator($request->all())->validate();

    $user = $this->create($request->all());

    // Убираем автоматический вход
    // $this->guard()->login($user);

    return $this->registered($request, $user)
                    ?: redirect($this->redirectPath());
}
```

## Безопасность

1. **Хеширование паролей:** Пароли надежно хешируются перед сохранением
2. **Валидация данных:** Проверка формата email, минимальной длины пароля
3. **CSRF защита:** Все формы включают CSRF токен
4. **Уникальность email:** Предотвращает дублирование аккаунтов
5. **Ограничение регистрации:** Дополнительная защита от создания аккаунтов
   после настройки системы

## Примечания

1. Стандартный middleware `guest` закомментирован, что позволяет
   аутентифицированным пользователям видеть страницу регистрации (но они будут
   перенаправлены из-за кастомной логики)
2. Система, вероятно, предназначена для scenarios, где только один администратор
   может создать аккаунт, после чего регистрация отключается
3. Пользовательская модель User должна иметь поле `role_id` для корректной
   работы логики ограничения
