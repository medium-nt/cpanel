# MarketplaceOrderItemController

## Общее назначение контроллера

Контроллер управляет отдельными товарами в заказах с маркетплейсов. Обеспечивает
управление жизненным циклом товаров: от получения в работу до выполнения,
включая распределение между сотрудниками (швеями, закройщиками), интеграцию с
API маркетплейсов для маркировки и печать документации.

## Зависимости и внедрения

- `App\Models\MarketplaceOrder` - Eloquent модель заказа
- `App\Models\MarketplaceOrderItem` - Eloquent модель товара в заказе
- `App\Models\Order` - Eloquent модель внутреннего заказа
- `App\Models\Sku` - Eloquent модель SKU
- `App\Models\User` - Eloquent модель пользователя (сотрудника)
- `App\Services\MarketplaceApiService` - Сервис для работы с API маркетплейсов
- `App\Services\MarketplaceOrderItemService` - Сервис бизнес-логики товаров
  заказов
- `App\Services\TransactionService` - Сервис для работы с транзакциями (бонусы)
- `Barryvdh\DomPDF\Facade\Pdf` - Фасад для генерации PDF
- `Illuminate\Http\Request` - Стандартный Request класс Laravel
- `Illuminate\Support\Facades\Log` - Фасад для логирования

## Список всех методов с описанием

### `index(Request $request)`

- **Описание:** Отображает список товаров для пошива с фильтрацией по статусу
- **Параметры:**
    - `$request` (Request) - HTTP запрос с параметром `status`:
        - `new` - новые заказы
        - `cutting` - в раскрое
        - `in_work` - в работе
        - `cut` - отрезано
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_order_items.index`
- **Используемые Gates/проверки:**
    - Швеи не могут видеть новые заказы и заказы в раскрое (редирект на in_work)
    - Закройщики не могут видеть новые заказы (редирект на cutting)
    - ОТК не могут видеть новые заказы (редирект на cut)
- **Валидация:** Не требуется (только чтение данных)
- **Работа с БД:**
    - Использует `MarketplaceOrderItemService::getFiltered()` для получения
      товаров
    - Получает бонусы сотрудников через
      `TransactionService::getBonusForTodayOrdersByUsers()`
    - Получает список пользователей с ролями 1 и 4 (кроме тестовых)
- **Особенности бизнес-логики:**
    - Разделение доступа по ролям сотрудников
    - Пагинация по 50 записей
    - Отображение бонусов для сотрудников

### `done(Request $request, MarketplaceOrderItem $marketplaceOrderItem)`

- **Описание:** Отмечает товар заказа как выполненный швеей
- **Параметры:**
    - `$request` (Request) - HTTP запрос
    - `$marketplaceOrderItem` (MarketplaceOrderItem) - Модель товара
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Возврат на предыдущую
  страницу
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Обновляет статус внутреннего заказа на 3
    - Обновляет статус маркетплейс заказа на 6
    - Обновляет статус товара на 3
    - Устанавливает `completed_at` для всех записей
- **Особенности бизнес-логики:**
    - Логирует выполнение заказа в канал 'erp'
    - Записывает информацию о швее и заказе

### `cancel(Request $request, MarketplaceOrderItem $marketplaceOrderItem)`

- **Описание:** Отменяет выполнение заказа швеей с начислением штрафа
- **Параметры:**
    - `$request` (Request) - HTTP запрос
    - `$marketplaceOrderItem` (MarketplaceOrderItem) - Модель товара
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект с сообщением
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:** Делегирует
  `MarketplaceOrderItemService::cancelToSeamstress()`
- **Особенности бизнес-логики:**
    - Начисляет штраф швее через сервис
    - Возвращает的成功 или сообщение об ошибке

### `labeling(Request $request, MarketplaceOrderItem $marketplaceOrderItem)`

- **Описание:** Передает товар на стикеровку/маркировку
- **Параметры:**
    - `$request` (Request) - HTTP запрос
    - `$marketplaceOrderItem` (MarketplaceOrderItem) - Модель товара
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Обновляет статус товара на 5
    - Устанавливает `completed_at`
- **Особенности бизнес-логики:**
    - Для FBS заказов вызывает API маркетплейса:
        - Ozon: `MarketplaceApiService::collectOrderOzon()`
        - WB: `MarketplaceApiService::collectOrderWb()`
    - Логирует передачу на стикеровку
    - Обрабатывает ошибки API

### `getNewOrderItem()`

- **Описание:** Распределяет новый товар заказа сотруднику в работу
- **Параметры:** Нет
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:** Делегирует `MarketplaceOrderItemService::getNewOrderItem()`
- **Особенности бизнес-логики:**
    - Автоматическое распределение заказов
    - Проверяет доступность новых заказов

###
`completeCutting(Request $request, MarketplaceOrderItem $marketplaceOrderItem)`

- **Описание:** Отмечает выполнение раскроя товара закройщиком
- **Параметры:**
    - `$request` (Request) - HTTP запрос
    - `$marketplaceOrderItem` (MarketplaceOrderItem) - Модель товара
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Возврат на предыдущую
  страницу
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Обновляет статус внутреннего заказа на 3
    - Обновляет статус товара на 8
    - Устанавливает `cutting_completed_at`
- **Особенности бизнес-логики:**
    - Логирует выполнение раскроя
    - Записывает информацию о закройщике

### `printCutting(MarketplaceOrderItemService $service)`

- **Описание:** Генерирует PDF файл с раскроем для текущего пользователя
- **Параметры:**
    - `$service` (MarketplaceOrderItemService) - Сервис работы с товарами
- **Возвращает:** `Barryvdh\DomPDF\PDF` - PDF файл для скачивания
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:** Использует
  `$service->getOrdersGroupedByMaterial(auth()->user())`
- **Особенности бизнес-логики:**
    - Генерирует PDF с группировкой по материалам
    - Формат А4
    - Имя файла: cutting.pdf

## Статусы товаров заказа

- **0** - Новый
- **8** - В раскрое
- **1** - Отрезано
- **2** - В работе
- **5** - Передан на стикеровку
- **3** - Выполнен

## Общие паттерны и особенности

1. **Ролевая модель доступа:**
    - Разные права просмотра для швей, закройщиков, ОТК
    - Автоматические редиректы в зависимости от роли

2. **Интеграция с API маркетплейсов:**
    - Передача заказов на стикеровку (FBS)
    - Обработка ошибок API
    - Логирование операций

3. **Журналирование:**
    - Все важные действия логируются в канал 'erp'
    - Фиксируется кто, когда и что выполнил

4. **PDF генерация:**
    - Использование DomPDF для печати раскроек
    - Группировка по материалам для оптимизации

5. **Сервисный слой:**
    - Сложная логика вынесена в сервисы
    - `MarketplaceOrderItemService` для основной логики
    - `MarketplaceApiService` для интеграций
    - `TransactionService` для финансовых операций
