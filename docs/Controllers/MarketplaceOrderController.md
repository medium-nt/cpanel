# MarketplaceOrderController

## Общее назначение контроллера

Контроллер управляет заказами с маркетплейсов. Обеспечивает полный жизненный
цикл заказа: от создания до выполнения, включая управление статусами, товарами в
заказе и интеграцию с поставками.

## Зависимости и внедрения

- `App\Http\Requests\StoreMarketplaceOrderRequest` - Request класс для валидации
  данных заказа
- `App\Models\MarketplaceItem` - Eloquent модель товара маркетплейса
- `App\Models\MarketplaceOrder` - Eloquent модель заказа
- `App\Models\MarketplaceOrderItem` - Eloquent модель товара в заказе
- `App\Services\MarketplaceOrderService` - Сервис для бизнес-логики работы с
  заказами
- `Illuminate\Http\Request` - Стандартный Request класс Laravel
- `Illuminate\Support\Facades\Validator` - Валидатор Laravel

## Список всех методов с описанием

### `index(Request $request)`

- **Описание:** Отображает список заказов с фильтрацией по статусу и
  маркетплейсу
- **Параметры:**
    - `$request` (Request) - HTTP запрос с параметрами фильтрации:
        - `status` (string) - Статус заказа (0, 3, 6)
        - `marketplace_id` (int) - ID маркетплейса
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_orders.index`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется (только чтение данных)
- **Работа с БД:**
    - Использует `MarketplaceOrder::query()` с фильтрацией
    - Сортировка по `created_at`
    - Пагинация по 10 записей на страницу
- **Особенности бизнес-логики:**
    - Match выражение для фильтрации по статусам
    - Сохраняет параметры запроса для пагинации

### `create()`

- **Описание:** Отображает форму создания нового заказа
- **Параметры:** Нет
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_orders.create`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется (отображение формы)
- **Работа с БД:** Получает все товары маркетплейса (`MarketplaceItem::all()`)
- **Особенности бизнес-логики:** Нет

### `store(StoreMarketplaceOrderRequest $request)`

- **Описание:** Создает новый заказ с товарами
- **Параметры:**
    - `$request` (StoreMarketplaceOrderRequest) - Валидированные данные заказа
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
  заказов
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Выполняется в `StoreMarketplaceOrderRequest`
- **Работа с БД:** Делегирует создание заказа `MarketplaceOrderService::store()`
- **Особенности бизнес-логики:**
    - Возвращает ошибку если внутренняя проблема при создании
    - Создает заказ и связанные товары через сервис

### `edit(MarketplaceOrder $marketplaceOrder)`

- **Описание:** Отображает форму редактирования заказа
- **Параметры:**
    - `$marketplaceOrder` (MarketplaceOrder) - Модель заказа (route model
      binding)
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_orders.edit`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется (отображение формы)
- **Работа с БД:**
    - Получает все товары маркетплейса
    - Передает модель заказа в представление
- **Особенности бизнес-логики:** Нет

### `update(Request $request, MarketplaceOrder $marketplaceOrder)`

- **Описание:** Обновляет данные заказа и его товары
- **Параметры:**
    - `$request` (Request) - Данные для обновления
    - `$marketplaceOrder` (MarketplaceOrder) - Модель заказа для обновления
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
  заказов
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:**
    - Кастомная валидация через `Validator::make`
    - Правила для каждого товара в заказе:
        - `order_item_id` - обязательный, должен существовать
        - `order_id`, `marketplace_id`, `item_id` - обязательные
        - `quantity` - целое число, минимум 1
        - `fulfillment_type` - должен быть FBO или FBS
- **Работа с БД:**
    - Обновляет основные данные заказа
    - Обновляет товары в заказе через `MarketplaceOrderItem`
- **Особенности бизнес-логики:**
    - Формирует массив данных только для товаров с количеством > 0
    - Обновляет статус заказа на 0 при редактировании

### `complete(MarketplaceOrder $marketplaceOrder)`

- **Описание:** Отмечает заказ как выполненный
- **Параметры:**
    - `$marketplaceOrder` (MarketplaceOrder) - Модель заказа для завершения
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Возврат на предыдущую
  страницу
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Обновляет статус на 3 (выполнен)
    - Устанавливает `completed_at` = текущее время
- **Особенности бизнес-логики:** Просто меняет статус заказа на выполненный

### `destroy(MarketplaceOrder $marketplaceOrder)`

- **Описание:** Удаляет заказ из системы
- **Параметры:**
    - `$marketplaceOrder` (MarketplaceOrder) - Модель заказа для удаления
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
  заказов
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:** Удаляет заказ если проверка прошла
- **Особенности бизнес-логики:**
    - Проверяет что все товары в заказе имеют статус 0
    - Защищает от удаления заказов с товарами уже в работе

### `remove(MarketplaceOrder $marketplace_order)`

- **Описание:** Удаляет заказ из поставки (не удаляет сам заказ)
- **Параметры:**
    - `$marketplace_order` (MarketplaceOrder) - Модель заказа
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на страницу
  поставки
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Обнуляет `supply_id` у заказа
    - Сохраняет изменения
- **Особенности бизнес-логики:**
    - Сохраняет ID поставки перед очисткой для редиректа
    - Не удаляет заказ, только отвязывает от поставки

## Общие паттерны и особенности

1. **Статусы заказа:**
    - 0 - новый/обрабатывается
    - 3 - выполнен/завершен
    - 6 - завершен (после выполнения всех товаров)

2. **Типы выполнения (fulfillment_type):**
    - FBO (Fulfillment by Ozon)
    - FBS (Fulfillment by Seller)

3. **Защита от ошибок:**
    - Проверки статусов перед удалением
    - Валидация данных обновления
    - Проверка на пустое количество товаров

4. **Интеграция с поставками:** Заказы могут быть привязаны к поставкам через
   `supply_id`
