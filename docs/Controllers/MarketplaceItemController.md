# MarketplaceItemController

## Общее назначение контроллера

Контроллер управляет товарами маркетплейсов в системе. Обеспечивает полный
CRUD-цикл для товаров, включая их создание, редактирование, удаление, а также
управление SKU и расходом материалов для каждого товара.

## Зависимости и внедрения

- `App\Http\Requests\SaveMarketplaceItemRequest` - Request класс для валидации
  данных товара
- `App\Models\MarketplaceItem` - Eloquent модель товара маркетплейса
- `App\Models\Material` - Eloquent модель материала
- `App\Models\MaterialConsumption` - Eloquent модель расхода материалов
- `App\Services\MarketplaceItemService` - Сервис для бизнес-логики работы с
  товарами
- `Illuminate\Http\Request` - Стандартный Request класс Laravel

## Список всех методов с описанием

### `index(Request $request)`

- **Описание:** Отображает список всех товаров маркетплейса с возможностью
  фильтрации
- **Параметры:**
    - `$request` (Request) - HTTP запрос с параметрами фильтрации
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_items.index`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется (только чтение данных)
- **Работа с БД:**
    - Использует `MarketplaceItemService::getFilteredItems()` для получения
      отфильтрованных товаров
    - Пагинация по 20 записей на страницу
- **Особенности бизнес-логики:**
    - Передает в представление списки уникальных названий и ширин материалов
      через сервис

### `create()`

- **Описание:** Отображает форму создания нового товара
- **Параметры:** Нет
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_items.create`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется (отображение формы)
- **Работа с БД:**
    - Получает все товары (`MarketplaceItem::all()`)
    - Получает все материалы (`Material::all()`)
- **Особенности бизнес-логики:** Нет

### `store(SaveMarketplaceItemRequest $request)`

- **Описание:** Создает новый товар маркетплейса в системе
- **Параметры:**
    - `$request` (SaveMarketplaceItemRequest) - Валидированные данные товара
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
  товаров с сообщением об успехе
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Выполняется в `SaveMarketplaceItemRequest`
- **Работа с БД:**
    - Создает запись в `MarketplaceItem`
    - Через `MarketplaceItemService` сохраняет связанные SKU
    - Через `MarketplaceItemService` сохраняет расход материалов
- **Особенности бизнес-логики:**
    - Сохраняет параметры фильтрации (title, width) в URL редиректа для
      сохранения контекста

### `edit(MarketplaceItem $marketplaceItem)`

- **Описание:** Отображает форму редактирования существующего товара
- **Параметры:**
    - `$marketplaceItem` (MarketplaceItem) - Модель товара (route model binding)
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_items.edit`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется (отображение формы)
- **Работа с БД:**
    - Получает все материалы (`Material::all()`)
    - Получает расход материалов для конкретного товара
- **Особенности бизнес-логики:** Нет

###
`update(SaveMarketplaceItemRequest $request, MarketplaceItem $marketplaceItem)`

- **Описание:** Обновляет данные существующего товара
- **Параметры:**
    - `$request` (SaveMarketplaceItemRequest) - Валидированные данные товара
    - `$marketplaceItem` (MarketplaceItem) - Модель товара для обновления
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
  товаров с сообщением об успехе
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Выполняется в `SaveMarketplaceItemRequest`
- **Работа с БД:**
    - Обновляет данные товара
    - Через `MarketplaceItemService` обновляет связанные SKU
    - Через `MarketplaceItemService` обновляет расход материалов
- **Особенности бизнес-логики:**
    - Сохраняет параметры фильтрации (title, width) в URL редиректа

### `destroy(MarketplaceItem $marketplaceItem)`

- **Описание:** Удаляет товар из системы
- **Параметры:**
    - `$marketplaceItem` (MarketplaceItem) - Модель товара для удаления
- **Возвращает:** `Illuminate\Http\RedirectResponse` - Редирект на список
  товаров с сообщением
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Проверяет наличие связанных записей в `marketplace_order_item`
    - Удаляет товар если нет связей
- **Особенности бизнес-логики:**
    - Защищает от удаления товары, которые используются в заказах
    - Возвращает ошибку если товар используется в системе

## Общие паттерны и особенности

1. **Использование сервисов:** Вся сложная бизнес-логика вынесена в
   `MarketplaceItemService`
2. **Сохранение контекста фильтрации:** При редиректах сохраняются параметры
   фильтрации
3. **Soft protection:** Контроллер предотвращает удаление товаров, которые
   используются в системе
4. **Работа с связанными данными:** Управление SKU и расходом материалов через
   сервисы
