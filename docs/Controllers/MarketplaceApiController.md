# MarketplaceApiController

## Общее назначение контроллера

Контроллер обеспечивает взаимодействие с API маркетплейсов (Ozon и Wildberries).
Отвечает за проверку и синхронизацию данных товаров, получение штрихкодов для
заказов, загрузку информации о новых и отмененных товарах.

## Зависимости и внедрения

- `App\Models\MarketplaceOrder` - Eloquent модель заказа с маркетплейса
- `App\Models\Sku` - Eloquent модель SKU (артикулов)
- `App\Services\MarketplaceApiService` - Сервис для работы с API маркетплейсов

## Список всех методов с описанием

### `checkSkuz()`

- **Описание:** Проверяет материалы (SKU), которые существуют в маркетплейсах но
  отсутствуют в ERP системе
- **Параметры:** Нет
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_api.check_skuz`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Получает все товары с Ozon через
      `MarketplaceApiService::getAllItemsOzon()`
    - Получает все товары с Wildberries через
      `MarketplaceApiService::getAllItemsWb()`
    - Использует `MarketplaceApiService::getNotFoundSkus()` для поиска
      отсутствующих
- **Особенности бизнес-логики:**
    - Объединяет данные с обоих маркетплейсов
    - Отображает список SKU, которые нужно добавить в ERP

### `checkDuplicateSkuz()`

- **Описание:** Проверяет наличие дублирующихся SKU в ERP системе
- **Параметры:** Нет
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_api.check_duplicate_skuz`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:**
    - Использует SQL запрос с группировкой и HAVING для поиска дубликатов
    - Выполняет: `GROUP BY sku HAVING COUNT(*) > 1`
- **Особенности бизнес-логики:**
    - Показывает количество вхождений каждого дубликата
    - Помогает поддерживать уникальность артикулов

### `uploadingNewProducts()`

- **Описание:** Загружает информацию о новых товарах с маркетплейсов
- **Параметры:** Нет
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_api.uploading_new_products`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:** Делегирует `MarketplaceApiService::uploadingNewProducts()`
- **Особенности бизнес-логики:**
    - Синхронизирует новые товары из маркетплейсов
    - Отображает отчет о результатах загрузки

### `uploadingCancelledProducts()`

- **Описание:** Загружает информацию об отмененных заявках/товарах
- **Параметры:** Нет
- **Возвращает:** `Illuminate\View\View` - Представление
  `marketplace_api.uploading_cancelled_products`
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:** Не требуется
- **Работа с БД:** Делегирует
  `MarketplaceApiService::uploadingCancelledProducts()`
- **Особенности бизнес-логики:**
    - Обрабатывает отмененные заказы
    - Отображает отчет обработки

### `getBarcodeFile(MarketplaceApiService $service)`

- **Описание:** Получает файл со штрихкодами для заказа
- **Параметры:**
    - `$service` (MarketplaceApiService) - Сервис API
- **Возвращает:** `Response` - Файл штрихкодов или текст ошибки
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:**
    - Проверяет наличие заказа в БД
- **Работа с БД:**
    - Ищет заказ по `marketplaceOrderId` из запроса
    - Обновляет поле `is_printed` = true
- **Особенности бизнес-логики:**
    - Определяет маркетплейс по `order.marketplace_id`:
        - 1 (Ozon): `MarketplaceApiService::getBarcodeOzon()`
        - 2 (Wildberries): `MarketplaceApiService::getBarcodeWb()`
    - Помечает заказ как напечатанный

### `getFBOBarcodeFile(MarketplaceApiService $service)`

- **Описание:** Получает файл со штрихкодами для FBO заказов Ozon
- **Параметры:**
    - `$service` (MarketplaceApiService) - Сервис API
- **Возвращает:** `Response` - Файл штрихкодов FBO
- **Используемые Gates/проверки:** Нет явных проверок прав
- **Валидация:**
    - Проверяет наличие заказа
- **Работа с БД:**
    - Ищет заказ по `marketplaceOrderId`
    - Обновляет `is_printed` = true
- **Особенности бизнес/логики:**
    - Специфичный метод для FBO (Fulfillment by Ozon)
    - Использует `MarketplaceApiService::getBarcodeOzonFBO()`
    - Прерывает выполнение если заказ не найден (exit)

## Идентификаторы маркетплейсов

- **1** - Ozon
- **2** - Wildberries

## Общие паттерны и особенности

1. **Интеграция с API:**
    - Вся работа с API маркетплейсов вынесена в `MarketplaceApiService`
    - Поддержка двух основных маркетплейсов: Ozon и Wildberries

2. **Проверка целостности данных:**
    - Поиск отсутствующих SKU
    - Поиск дубликатов артикулов
    - Синхронизация данных между ERP и маркетплейсами

3. **Работа с файлами:**
    - Генерация и скачивание файлов штрихкодов
    - Отметка заказов как напечатанных
    - Поддержка разных форматов (FBO, FBS)

4. **Отчетность:**
    - Все методы загрузки возвращают отчеты
    - Отображение результатов операций в представлениях

5. **Обработка ошибок:**
    - Проверка существования заказов
    - Обработка отсутствующих файлов
    - Прерывание выполнения при критических ошибках
