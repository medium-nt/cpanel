# TelegramController

**Путь:** `app/Http/Controllers/TelegramController.php`

**Описание:** Контроллер для обработки webhook'ов Telegram бота и авторизации
пользователей

**Зависимости:**

- `App\Models\User` - модель пользователя
- `App\Services\TgService` - сервис Telegram
- `App\Services\UserService` - сервис пользователей
- `Illuminate\Http\Request` - HTTP запросы
- `Illuminate\Support\Facades\Log` - логирование

---

## Методы контроллера

### webhook(Request $request)

- **Описание:** Обработка входящих обновлений от Telegram API
- **Параметры:** `$request` - HTTP запрос с данными от Telegram
- **Возвращает:** `Illuminate\Http\JsonResponse`
- **Логика:**
    1. Получает все данные из запроса
    2. Логирует входящее сообщение в канал `tg_api`
    3. Проверяет наличие поля `message` в обновлении
    4. Извлекает `chat_id` из сообщения
    5. Ищет пользователя в БД по `tg_id`
- **Сценарии обработки:**
    - **Пользователь не найден:**
        - Отправляет приветственное сообщение
        - Предлагает авторизоваться по специальной ссылке
        - Ссылка: `url()->route('profile', ['tg_id' => $tgId])`
    - **Пользователь найден:**
        - Отправляет сообщение о успешной авторизации
        - Отображает имя и роль пользователя
        - Информирует о готовности к приему уведомлений

---

## Особенности реализации

1. **Webhook обработка:** Контроллер предназначен для обработки webhook'ов от
   Telegram
2. **Двухфакторная авторизация:**
    - Первоначальное сообщение требует веб-авторизацию
    - Последующие сообщения работают автоматически
3. **Логирование:** Все запросы логируются для отладки и мониторинга
4. **Безопасность:** Никаких прямых ответов на команды - только обработка
   авторизации

---

## Поток авторизации

1. Пользователь находит бота в Telegram и отправляет любое сообщение
2. Бот получает webhook и проверяет наличие пользователя в системе
3. Если пользователь не найден:
    - Бот отправляет ссылку для авторизации
    - Пользователь переходит по ссылке в веб-интерфейс
    - Веб-интерфейс сохраняет `tg_id` в профиль пользователя
4. После успешной авторизации бот подтверждает готовность к работе

---

## Сообщения бота

### Для нового пользователя:

```
Привет! Я бот компании Мегатюль. Для начала работы вы должны авторизоваться по этой ссылке: [URL]
```

### Для авторизованного пользователя:

```
Привет, [Имя]! Вы уже авторизованы в системе как [Роль] и теперь будете получать все уведомления системы через меня.
```

---

## Роуты

- `POST /telegram/webhook` - `webhook` - обработчик webhook'ов Telegram

---

## Сервисные зависимости

### TgService

- `sendMessage($chatId, $message)` - отправка сообщения пользователю

### UserService

- `translateRoleName($roleName)` - перевод названия роли на русский язык

---

## Конфигурация

Для работы контроллера необходимо:

1. Настроить webhook в Telegram Bot API
2. Указать `TELEGRAM_BOT_TOKEN` в `.env` файле
3. Настроить маршрут webhook'а в `routes/web.php` или `routes/api.php`

---

## Логирование

- Все входящие запросы логируются в канал `tg_api`
- Формат лога: полный JSON объект от Telegram API
- Используется для мониторинга и отладки работы бота
