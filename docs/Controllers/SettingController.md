# SettingController

**Путь:** `app/Http/Controllers/SettingController.php`

**Описание:** Контроллер для управления системными настройками, тестовыми
функциями и административными утилитами

**Зависимости:**

- `App\Http\Requests\SaveSettingRequest` - Form Request валидации
- `App\Models\MovementMaterial` - модель движения материалов
- `App\Models\Order` - модель заказов
- `App\Models\Setting` - модель настроек
- `App\Services\TgService` - сервис Telegram
- `App\Services\TransactionService` - сервис транзакций
- `Illuminate\Support\Facades\DB` - Database facade
- `Illuminate\Support\Facades\Log` - логирование

---

## Публичные методы

### index()

- **Описание:** Отображение страницы системных настроек
- **Возвращает:** `Illuminate\View\View`
- **Данные:**
    - `title` (string) - "Настройки системы"
    - `settings` (object) - коллекция настроек в формате name => value
- **View:** `settings.index`

### save(SaveSettingRequest $request)

- **Описание:** Сохранение системных настроек
- **Параметры:** `$request` - валидированные данные настроек
- **Возвращает:** `Illuminate\Http\RedirectResponse`
- **Логика:**
    - Извлекает все данные кроме _method и _token
    - Преобразует null значения в пустые строки
    - Обновляет настройки в базе данных
    - Логирует изменения в канал `erp`
- **Редирект:** `route('setting.index')` с сообщением об успехе

### test()

- **Описание:** Тестовая функция для разработки и отладки
- **Ограничение:** Работает только на development сервере
- **Возможности:**
    - Отправка тестовых сообщений в Telegram
    - Прямой вызов API Telegram (закомментировано)
    - Выполнение произвольного кода для разработки
- **Действие:** Выводит сообщение о сервере и завершает выполнение

---

## Статические методы (административные утилиты)

### duplicates()

- **Описание:** Поиск и обработка дублирующихся заказов маркетплейсов
- **Действие:**
    1. Ищет заказы с одинаковым `marketplace_order_id`
    2. Фильтрует по типу движения (3) и ID (> 10940)
    3. Группирует заказы по `marketplace_order_id`
    4. Отображает HTML таблицу с результатами
- **Фильтры:**
    - Тип движения: 3
    - Минимальный ID: 10940
    - Более одного заказа с одинаковым marketplace_order_id
- **Отображаемая информация:**
    - ID заказа
    - Швея
    - Раскройщик
    - Комментарии
    - Дата создания
    - Количество MovementMaterial записей
- **Действия по удалению (закомментировано):**
    - Удаление записей раскройщиков
    - Удаление связанных MovementMaterial
- **Вывод:** Прямой HTML输出 с использованием Bootstrap стилей

### salary()

- **Описание:** Принудительное начисление зарплаты швеям
- **Использует:** `TransactionService::accrualSeamstressesSalary(true)`
- **Параметр:** `true` - принудительный режим
- **Возврат:** Нет (выполняет действие)

---

## Особенности реализации

1. **Валидация:** Используется Form Request для валидации настроек
2. **Логирование:** Все изменения настроек логируются
3. **HTML вывод:** Метод `duplicates()` генерирует HTML напрямую
4. **Только для разработки:** Метод `test()` имеет проверку окружения
5. **Прямые SQL запросы:** Используются DB::raw в методе `duplicates()`

---

## Роуты

- `GET /setting` - `index` - страница настроек
- `POST /setting/save` - `save` - сохранение настроек
- `GET /setting/test` - `test` - тестовая страница
- `GET /setting/duplicates` - `duplicates` - поиск дубликатов
- `GET /setting/salary` - `salary` - начисление зарплаты

---

## Сервисные зависимости

### TgService

- `sendMessage($chatId, $message)` - отправка сообщений

### TransactionService

- `accrualSeamstressesSalary($force)` - начисление зарплаты

---

## Безопасность

1. **Тестовые методы:** Имеют ограничение на рабочие окружения
2. **Валидация:** Все входные данные проверяются через Request классы
3. **Логирование:** Все действия记录 в лог файлы
4. **Права доступа:** Предполагается использование middleware для ограничения
   доступа

---

## Предупреждения

- Метод `duplicates()` выполняет прямые операции с БД
- Тестовые функции не должны быть доступны на production
- HTML вывод в `duplicates()` требует дополнительного XSS-фильтрования при
  использовании
